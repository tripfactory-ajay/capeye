<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Stock - Capeye Auto Capital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
        .glass-panel { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .drop-zone { transition: all 0.3s ease; }
        .drop-zone.dragover { background: #eff6ff; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    
    <!-- Auth Check -->
    <script>
        (function() {
            const session = localStorage.getItem('capeye_session');
            if (!session) {
                sessionStorage.setItem('redirect_after_login', window.location.href);
                window.location.replace('./login.html');
                return;
            }
        })();
    </script>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <img src="./autocapital-logo.png" alt="Auto Capital" class="h-10 w-auto object-contain" onerror="this.style.display='none'">
                    <span class="ml-3 text-xl font-bold text-slate-800">Import Stock</span>
                </div>
                <div class="hidden md:flex items-center space-x-1">
                    <a href="./index.html" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-lg transition">Dashboard</a>
                    <a href="./operations.html" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-lg transition">Operations</a>
                    <a href="./inventory.html" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-lg transition">Inventory</a>
                    <a href="./workflow.html" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-lg transition">Workflow</a>
                    <a href="./analytics.html" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-lg transition">Analytics</a>
                    <button onclick="logout()" class="ml-4 px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
                <!-- Mobile menu button -->
                <div class="md:hidden flex items-center">
                    <button onclick="toggleMobileMenu()" class="text-slate-600 hover:text-slate-900 p-2">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden bg-white border-t border-slate-200">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="./index.html" class="block px-3 py-2 text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-md">Dashboard</a>
                <a href="./operations.html" class="block px-3 py-2 text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-md">Operations</a>
                <a href="./inventory.html" class="block px-3 py-2 text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-md">Inventory</a>
                <a href="./workflow.html" class="block px-3 py-2 text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-md">Workflow</a>
                <a href="./analytics.html" class="block px-3 py-2 text-base font-medium text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-md">Analytics</a>
                <button onclick="logout()" class="w-full text-left px-3 py-2 text-base font-medium text-red-600 hover:bg-red-50 rounded-md">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h1 class="text-3xl font-bold text-slate-900 mb-8">Import Vehicle Stock</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Upload Section -->
            <div class="lg:col-span-2">
                <div class="glass-panel rounded-xl p-6 shadow-sm mb-6">
                    <h2 class="text-lg font-semibold text-slate-900 mb-4">Upload CSV File</h2>
                    
                    <!-- Drop Zone -->
                    <div id="dropZone" class="drop-zone border-2 border-dashed border-slate-300 rounded-xl p-12 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition">
                        <i class="fas fa-cloud-upload-alt text-5xl text-slate-400 mb-4"></i>
                        <p class="text-lg font-medium text-slate-700 mb-2">Drop your CSV file here</p>
                        <p class="text-sm text-slate-500 mb-4">or click to browse</p>
                        <input type="file" id="fileInput" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
                        <button onclick="document.getElementById('fileInput').click()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            Select File
                        </button>
                    </div>

                    <!-- File Info -->
                    <div id="fileInfo" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-file-csv text-2xl text-blue-600 mr-3"></i>
                                <div>
                                    <p class="font-medium text-slate-900" id="fileName">filename.csv</p>
                                    <p class="text-sm text-slate-600" id="fileSize">0 KB</p>
                                </div>
                            </div>
                            <button onclick="clearFile()" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Preview Table -->
                    <div id="previewSection" class="hidden mt-6">
                        <h3 class="text-md font-semibold text-slate-900 mb-3">Preview (First 5 rows)</h3>
                        <div class="overflow-x-auto border border-slate-200 rounded-lg">
                            <table class="w-full text-sm text-left" id="previewTable">
                                <!-- Preview content -->
                            </table>
                        </div>
                        
                        <div class="flex gap-3 mt-4">
                            <button onclick="processImport()" class="flex-1 px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition">
                                <i class="fas fa-check mr-2"></i>Import Data
                            </button>
                            <button onclick="clearFile()" class="px-6 py-3 bg-slate-200 text-slate-700 font-medium rounded-lg hover:bg-slate-300 transition">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Progress -->
                    <div id="progressSection" class="hidden mt-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-slate-700">Importing...</span>
                            <span class="text-sm text-slate-600" id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div id="resultsSection" class="hidden mt-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-check-circle text-green-600 text-2xl mr-3"></i>
                                <div>
                                    <h3 class="font-semibold text-green-900">Import Complete!</h3>
                                    <p class="text-sm text-green-700" id="resultsText">Successfully imported X vehicles</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 mt-4">
                                <div class="text-center p-3 bg-white rounded-lg">
                                    <div class="text-2xl font-bold text-green-600" id="resultCreated">0</div>
                                    <div class="text-xs text-slate-600">New</div>
                                </div>
                                <div class="text-center p-3 bg-white rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600" id="resultUpdated">0</div>
                                    <div class="text-xs text-slate-600">Updated</div>
                                </div>
                                <div class="text-center p-3 bg-white rounded-lg">
                                    <div class="text-2xl font-bold text-red-600" id="resultErrors">0</div>
                                    <div class="text-xs text-slate-600">Errors</div>
                                </div>
                            </div>
                            <div class="mt-4 flex gap-3">
                                <a href="./inventory.html" class="flex-1 text-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    View Inventory
                                </a>
                                <button onclick="clearFile()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
                                    Import Another
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="lg:col-span-1">
                <div class="glass-panel rounded-xl p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-slate-900 mb-4">Instructions</h2>
                    <div class="space-y-4 text-sm text-slate-600">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                            <p>Upload a CSV file exported from ClickDealer or your stock management system.</p>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-600 mt-1 mr-3"></i>
                            <p>Required columns: Stock No, Registration, Make, Model</p>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-sync text-orange-600 mt-1 mr-3"></i>
                            <p>Existing vehicles will be updated based on Stock No match.</p>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-shield-alt text-purple-600 mt-1 mr-3"></i>
                            <p>Data is stored locally in your browser. No data is sent to any server.</p>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t border-slate-200">
                        <h3 class="font-medium text-slate-900 mb-2">Supported Formats</h3>
                        <ul class="text-sm text-slate-600 space-y-1">
                            <li>• ClickDealer exports</li>
                            <li>• Standard CSV files</li>
                            <li>• Excel files (save as CSV first)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentFile = null;
        let parsedData = null;

        // Drag and drop
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('Please upload a CSV file');
                return;
            }
            
            currentFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('fileInfo').classList.remove('hidden');
            
            // Parse CSV
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    parsedData = results.data;
                    showPreview(results.data.slice(0, 5), results.meta.fields);
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        }

        function showPreview(data, fields) {
            const table = document.getElementById('previewTable');
            const headers = fields.slice(0, 8); // Show first 8 columns
            
            let html = '<thead class="bg-slate-50 text-slate-600 uppercase text-xs"><tr>';
            headers.forEach(h => {
                html += `<th class="px-4 py-3">${h}</th>`;
            });
            html += '</tr></thead><tbody class="divide-y divide-slate-200">';
            
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(h => {
                    html += `<td class="px-4 py-3 text-slate-900">${row[h] || '-'}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
            document.getElementById('previewSection').classList.remove('hidden');
        }

        function processImport() {
            if (!parsedData) return;
            
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            
            // Simulate progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                progressPercent.textContent = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(completeImport, 300);
                }
            }, 100);
        }

        function completeImport() {
            const existing = JSON.parse(localStorage.getItem('capeye_vehicles') || '[]');
            let created = 0;
            let updated = 0;
            let errors = 0;
            
            parsedData.forEach(row => {
                if (!row['Stock No'] && !row['Registration']) {
                    errors++;
                    return;
                }
                
                const vehicle = mapRowToVehicle(row);
                const idx = existing.findIndex(v => 
                    v.stockNo === vehicle.stockNo || 
                    v.registration === vehicle.registration
                );
                
                if (idx >= 0) {
                    existing[idx] = { ...existing[idx], ...vehicle, updatedAt: new Date().toISOString() };
                    updated++;
                } else {
                    vehicle.id = Date.now() + Math.random();
                    vehicle.createdAt = new Date().toISOString();
                    existing.push(vehicle);
                    created++;
                }
            });
            
            localStorage.setItem('capeye_vehicles', JSON.stringify(existing));
            
            // Save import history
            const history = JSON.parse(localStorage.getItem('capeye_import_history') || '[]');
            history.push({
                date: new Date().toISOString(),
                total: parsedData.length,
                created: created,
                updated: updated,
                errors: errors
            });
            localStorage.setItem('capeye_import_history', JSON.stringify(history));
            
            // Show results
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultsText').textContent = `Processed ${parsedData.length} vehicles from ${currentFile.name}`;
            document.getElementById('resultCreated').textContent = created;
            document.getElementById('resultUpdated').textContent = updated;
            document.getElementById('resultErrors').textContent = errors;
        }

        function mapRowToVehicle(row) {
            return {
                stockNo: row['Stock No'] || row['StockNo'] || '',
                registration: row['Registration'] || row['Reg'] || '',
                make: row['Make'] || row['Manufacturer'] || '',
                model: row['Model'] || '',
                variant: row['Variant'] || '',
                year: row['Year'] || row['Reg Year'] || '',
                colour: row['Colour'] || row['Color'] || '',
                fuelType: row['Fuel Type'] || row['Fuel'] || '',
                transmission: row['Transmission'] || row['Gearbox'] || '',
                mileage: row['Mileage'] || '',
                body: row['Body'] || '',
                doors: row['Doors'] || '',
                location: row['Location'] || '',
                status: row['Status'] || 'In Stock',
                dateInStock: row['Date In Stock'] || row['DateInStock'] || new Date().toISOString(),
                costPrice: parseFloat(row['Cost Price'] || row['Cost'] || 0),
                retailPrice: parseFloat(row['Retail Price'] || row['Retail'] || 0),
                rfl: row['RFL'] || '',
                mot: row['MOT'] || '',
                fsh: row['FSH'] || false,
                keytag: row['Keytag'] || ''
            };
        }

        function clearFile() {
            currentFile = null;
            parsedData = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercent').textContent = '0%';
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        function logout() {
            localStorage.removeItem('capeye_session');
            window.location.replace('./login.html');
        }
    </script>
</body>
</html>
