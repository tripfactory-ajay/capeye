<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Operations | Capeye Auto Capital</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Capeye Design System -->
    <link rel="stylesheet" href="./css/capeye-system.css">
    
    <!-- Vehicle Store -->
    <script src="./js/vehicle-store.js"></script>
    
    <style>
        /* Operations Specific Styles */
        :root {
            --stage-intake: #3b82f6;
            --stage-workshop: #f59e0b;
            --stage-prep: #8b5cf6;
            --stage-ready: #10b981;
            --stage-advertised: #06b6d4;
            --alert-red: #dc2626;
            --alert-orange: #ea580c;
        }
        
        /* Pipeline Stages */
        .pipeline-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .pipeline-stage {
            background: var(--cy-bg-secondary);
            border: 1px solid var(--cy-border);
            border-radius: 16px;
            padding: 16px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .pipeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--stage-color);
        }
        
        .pipeline-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: var(--cy-text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pipeline-count {
            background: var(--stage-color);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        
        .pipeline-time {
            font-size: 11px;
            color: var(--cy-text-muted);
            margin-top: 4px;
        }
        
        .vehicle-card {
            background: var(--cy-bg-tertiary);
            border: 1px solid var(--cy-border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .vehicle-card:hover {
            border-color: var(--stage-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .vehicle-card.alert {
            border-left: 3px solid var(--alert-red);
            animation: pulse-alert 2s infinite;
        }
        
        .vehicle-card.warning {
            border-left: 3px solid var(--alert-orange);
        }
        
        @keyframes pulse-alert {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(220, 38, 38, 0); }
        }
        
        .vehicle-reg {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: var(--cy-text-primary);
            margin-bottom: 4px;
        }
        
        .vehicle-info {
            font-size: 11px;
            color: var(--cy-text-secondary);
            margin-bottom: 6px;
        }
        
        .vehicle-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
        }
        
        .vehicle-days {
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .vehicle-days.normal {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .vehicle-days.warning {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }
        
        .vehicle-days.danger {
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626;
        }
        
        .vehicle-assignee {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--cy-text-muted);
        }
        
        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(220, 38, 38, 0.05));
            border: 1px solid rgba(220, 38, 38, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .alert-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-icon {
            width: 40px;
            height: 40px;
            background: rgba(220, 38, 38, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #dc2626;
            font-size: 18px;
        }
        
        .alert-text h3 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 2px;
        }
        
        .alert-text p {
            font-size: 13px;
            color: #94a3b8;
        }
        
        /* Workshop Queue */
        .queue-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .queue-card {
            background: var(--cy-bg-secondary);
            border: 1px solid var(--cy-border);
            border-radius: 16px;
            padding: 20px;
        }
        
        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .queue-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--cy-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .job-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--cy-bg-tertiary);
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .job-row:hover {
            background: rgba(59, 130, 246, 0.05);
            border-left-color: #3b82f6;
        }
        
        .job-row.urgent {
            border-left-color: #dc2626;
            background: rgba(220, 38, 38, 0.05);
        }
        
        .job-vehicle {
            flex: 1;
        }
        
        .job-reg {
            font-weight: 700;
            color: var(--cy-text-primary);
            font-size: 13px;
        }
        
        .job-desc {
            font-size: 11px;
            color: var(--cy-text-secondary);
            margin-top: 2px;
        }
        
        .job-mechanic {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
        }
        
        .mechanic-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
        }
        
        .mechanic-name {
            font-size: 12px;
            color: var(--cy-text-secondary);
        }
        
        .job-time {
            text-align: right;
            min-width: 80px;
        }
        
        .time-elapsed {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: var(--cy-text-primary);
        }
        
        .time-label {
            font-size: 10px;
            color: var(--cy-text-muted);
        }
        
        .job-actions {
            display: flex;
            gap: 6px;
        }
        
        .job-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--cy-border);
            background: var(--cy-bg-secondary);
            color: var(--cy-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.2s;
        }
        
        .job-btn:hover {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        /* Staff Workload */
        .workload-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .workload-item {
            background: var(--cy-bg-tertiary);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        
        .workload-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--cy-text-primary);
            margin-bottom: 4px;
        }
        
        .workload-count {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: #3b82f6;
        }
        
        .workload-label {
            font-size: 10px;
            color: var(--cy-text-muted);
        }
        
        /* Ready to Advertise */
        .ready-section {
            background: var(--cy-bg-secondary);
            border: 1px solid var(--cy-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .ready-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .ready-card {
            background: var(--cy-bg-tertiary);
            border: 1px solid var(--cy-border);
            border-radius: 10px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ready-card:hover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }
        
        .ready-icon {
            width: 40px;
            height: 40px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #10b981;
            font-size: 16px;
        }
        
        .ready-info {
            flex: 1;
        }
        
        .ready-reg {
            font-weight: 700;
            color: var(--cy-text-primary);
            font-size: 13px;
        }
        
        .ready-status {
            font-size: 11px;
            color: #10b981;
            margin-top: 2px;
        }
        
        .ready-action {
            padding: 6px 12px;
            background: #10b981;
            color: white;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--cy-bg-secondary);
            border: 1px solid var(--cy-border);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }
        
        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--cy-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--cy-text-primary);
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--cy-border);
            background: var(--cy-bg-tertiary);
            color: var(--cy-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .timeline {
            position: relative;
            padding-left: 24px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--cy-border);
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--stage-color, #3b82f6);
            border: 2px solid var(--cy-bg-secondary);
        }
        
        .timeline-date {
            font-size: 11px;
            color: var(--cy-text-muted);
            margin-bottom: 4px;
        }
        
        .timeline-action {
            font-size: 13px;
            color: var(--cy-text-primary);
            font-weight: 600;
        }
        
        .timeline-person {
            font-size: 11px;
            color: var(--cy-text-secondary);
            margin-top: 2px;
        }
        
        /* Search Styles */
        .search-container {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--cy-bg-tertiary);
            border: 1px solid var(--cy-border);
            border-radius: 8px;
            color: var(--cy-text-primary);
            font-size: 13px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: var(--cy-bg-secondary);
            border: 1px solid var(--cy-border);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        
        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid var(--cy-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-result-item:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .result-stage-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .result-info {
            flex: 1;
        }
        
        .result-reg {
            font-weight: 600;
            color: var(--cy-text-primary);
            font-size: 13px;
        }
        
        .result-details {
            font-size: 11px;
            color: var(--cy-text-muted);
        }
        
        /* Global Header Search */
        .global-search-container {
            position: relative;
        }
        
        .global-search-results {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            width: 320px;
            background: var(--cy-bg-secondary);
            border: 1px solid var(--cy-border);
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .pipeline-container { grid-template-columns: repeat(3, 1fr); }
            .queue-section { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .pipeline-container { grid-template-columns: 1fr; }
            .workload-grid { grid-template-columns: 1fr; }
            .alert-banner { flex-direction: column; gap: 12px; text-align: center; }
        }
    </style>
</head>
<body>
    <!-- Background Effects -->
    <div class="cy-bg-grid"></div>
    <div class="cy-ambient-glow" style="top: -200px; right: -200px;"></div>
    <div class="cy-ambient-glow-red" style="bottom: -100px; left: -100px;"></div>

    <!-- Header -->
    <header class="cy-header">
        <div class="cy-header-content">
            <div style="display: flex; align-items: center; gap: 32px;">
                <a href="./index.html" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #dc2626, #991b1b); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-family: 'Space Grotesk', sans-serif; font-weight: 700; color: white; font-size: 16px;">AC</div>
                    <div>
                        <div style="font-family: 'Space Grotesk', sans-serif; font-size: 20px; font-weight: 700; color: #f8fafc;">CAPEYE</div>
                        <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 2px;">Auto Capital Intelligence</div>
                    </div>
                </a>
                
                <nav style="display: flex; align-items: center; gap: 8px;">
                    <a href="./index.html" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; color: #94a3b8; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <a href="./operations.html" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; color: #f8fafc; background: rgba(59, 130, 246, 0.1); text-decoration: none; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-cogs"></i> Operations
                    </a>
                    <a href="./inventory.html" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; color: #94a3b8; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-car"></i> Inventory
                    </a>
                    <a href="./workflow.html" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; color: #94a3b8; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-tasks"></i> Workflow
                    </a>
                    <a href="./analytics.html" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; color: #94a3b8; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-chart-bar"></i> Intelligence
                    </a>
                </nav>
            </div>
            
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="live-indicator" style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 20px; font-size: 12px; color: #10b981; font-weight: 600;">
                    <span class="pulse-dot" style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></span>
                    LIVE
                </div>
                
                <!-- Global Vehicle Search -->
                <div class="global-search-container">
                    <input type="text" id="globalSearch" placeholder="Find vehicle..." 
                           style="padding: 6px 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; color: #f8fafc; font-size: 13px; width: 180px;">
                    <div id="globalSearchResults" class="global-search-results"></div>
                </div>
                
                <button onclick="refreshOperations()" style="padding: 8px 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; font-size: 13px; font-weight: 500; color: #94a3b8; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                
                <button onclick="logout()" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; color: #dc2626; background: none; border: none; cursor: pointer;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="cy-container" style="padding: 24px; max-width: 1600px; margin: 0 auto;">
        
        <!-- Page Header -->
        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px;">
            <div>
                <h1 style="font-family: 'Space Grotesk', sans-serif; font-size: 32px; font-weight: 700; color: #f8fafc; margin-bottom: 6px;">
                    Live <span style="color: #3b82f6;">Operations</span>
                </h1>
                <p style="color: #94a3b8; font-size: 14px;">Real-time vehicle tracking and workshop management</p>
            </div>
            
            <div style="display: flex; gap: 16px; align-items: center;">
                <div style="text-align: right;">
                    <div style="font-family: 'Space Grotesk'; font-size: 28px; font-weight: 700; color: #f8fafc;" id="totalActiveVehicles">0</div>
                    <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">Active Vehicles</div>
                </div>
                <div style="width: 1px; height: 40px; background: rgba(255,255,255,0.1);"></div>
                <div style="text-align: right;">
                    <div style="font-family: 'Space Grotesk'; font-size: 28px; font-weight: 700; color: #f59e0b;" id="workshopLoad">0</div>
                    <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">In Workshop</div>
                </div>
                <div style="width: 1px; height: 40px; background: rgba(255,255,255,0.1);"></div>
                <div style="text-align: right;">
                    <div style="font-family: 'Space Grotesk'; font-size: 28px; font-weight: 700; color: #10b981;" id="readyToAdvertise">0</div>
                    <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">Ready to Advertise</div>
                </div>
            </div>
        </div>

        <!-- Quick Vehicle Search Section -->
        <div style="background: var(--cy-bg-secondary); border: 1px solid var(--cy-border); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
            <div style="display: flex; gap: 16px; align-items: end;">
                <div style="flex: 1;">
                    <label style="font-size: 11px; color: var(--cy-text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Quick Vehicle Search</label>
                    <div class="search-container" style="position: relative;">
                        <input type="text" id="quickSearch" class="search-input" placeholder="Enter stock number, registration, make or model...">
                        <div id="quickSearchResults" class="search-results"></div>
                    </div>
                </div>
                <div id="selectedVehicle" style="flex: 1; display: none;">
                    <!-- Shows selected vehicle quick actions -->
                </div>
            </div>
        </div>

        <!-- Alert Banner -->
        <div class="alert-banner" id="alertBanner" style="display: none;">
            <div class="alert-content">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-text">
                    <h3>Attention Required</h3>
                    <p id="alertMessage"> vehicles have been stuck for over 7 days</p>
                </div>
            </div>
            <button onclick="viewStuckVehicles()" style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                View Details
            </button>
        </div>

        <!-- Pipeline Stages -->
        <div class="pipeline-container">
            <!-- Stage 1: Intake/Yard -->
            <div class="pipeline-stage" style="--stage-color: #3b82f6;">
                <div class="pipeline-header">
                    <div>
                        <div class="pipeline-title">
                            <i class="fas fa-download"></i>
                            Intake / Yard
                        </div>
                        <div class="pipeline-time" id="avgIntakeTime">Avg: -- days</div>
                    </div>
                    <span class="pipeline-count" id="countIntake">0</span>
                </div>
                <div class="pipeline-vehicles" id="intakeVehicles"></div>
            </div>

            <!-- Stage 2: Workshop -->
            <div class="pipeline-stage" style="--stage-color: #f59e0b;">
                <div class="pipeline-header">
                    <div>
                        <div class="pipeline-title">
                            <i class="fas fa-wrench"></i>
                            Workshop
                        </div>
                        <div class="pipeline-time" id="avgWorkshopTime">Avg: -- days</div>
                    </div>
                    <span class="pipeline-count" id="countWorkshop">0</span>
                </div>
                <div class="pipeline-vehicles" id="workshopVehicles"></div>
            </div>

            <!-- Stage 3: Prep/Valeting -->
            <div class="pipeline-stage" style="--stage-color: #8b5cf6;">
                <div class="pipeline-header">
                    <div>
                        <div class="pipeline-title">
                            <i class="fas fa-spray-can"></i>
                            Prep / Valeting
                        </div>
                        <div class="pipeline-time" id="avgPrepTime">Avg: -- days</div>
                    </div>
                    <span class="pipeline-count" id="countPrep">0</span>
                </div>
                <div class="pipeline-vehicles" id="prepVehicles"></div>
            </div>

            <!-- Stage 4: Ready -->
            <div class="pipeline-stage" style="--stage-color: #10b981;">
                <div class="pipeline-header">
                    <div>
                        <div class="pipeline-title">
                            <i class="fas fa-check-circle"></i>
                            Ready
                        </div>
                        <div class="pipeline-time">Awaiting photos</div>
                    </div>
                    <span class="pipeline-count" id="countReady">0</span>
                </div>
                <div class="pipeline-vehicles" id="readyVehicles"></div>
            </div>

            <!-- Stage 5: Advertised -->
            <div class="pipeline-stage" style="--stage-color: #06b6d4;">
                <div class="pipeline-header">
                    <div>
                        <div class="pipeline-title">
                            <i class="fas fa-bullhorn"></i>
                            Advertised
                        </div>
                        <div class="pipeline-time">Live on platforms</div>
                    </div>
                    <span class="pipeline-count" id="countAdvertised">0</span>
                </div>
                <div class="pipeline-vehicles" id="advertisedVehicles"></div>
            </div>
        </div>

        <!-- Workshop Queue & Staff Workload -->
        <div class="queue-section">
            <div class="queue-card">
                <div class="queue-header">
                    <div class="queue-title">
                        <i class="fas fa-wrench" style="color: #f59e0b;"></i>
                        Workshop Jobs Queue
                    </div>
                    <button onclick="window.location.href='./workflow/stages/stage-1-intake.html'" style="padding: 6px 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 6px; font-size: 12px; font-weight: 600; color: #3b82f6; cursor: pointer;">
                        + New Intake
                    </button>
                </div>
                
                <div id="workshopQueue"></div>
            </div>

            <div class="queue-card">
                <div class="queue-header">
                    <div class="queue-title">
                        <i class="fas fa-users" style="color: #3b82f6;"></i>
                        Staff Workload
                    </div>
                </div>
                
                <div class="workload-grid" id="staffWorkload"></div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--cy-border);">
                    <div style="font-size: 12px; color: var(--cy-text-muted); margin-bottom: 8px;">Department Capacity</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="flex: 1; height: 6px; background: var(--cy-bg-tertiary); border-radius: 3px; overflow: hidden;">
                            <div id="capacityBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 3px; transition: width 0.5s;"></div>
                        </div>
                        <span id="capacityText" style="font-size: 12px; font-weight: 600; color: #3b82f6;">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ready to Advertise Section -->
        <div class="ready-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div class="queue-title">
                    <i class="fas fa-camera" style="color: #10b981;"></i>
                    Ready for Photography / Advertising
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="advertiseAll()" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
                        Advertise All
                    </button>
                </div>
            </div>
            
            <div class="ready-grid" id="readyToAdGrid"></div>
        </div>

    </main>

    <!-- Vehicle Detail Modal -->
    <div class="modal-overlay" id="vehicleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Vehicle Details</div>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <script>
        // Stage definitions
        const stages = {
            INTAKE: { name: 'Intake', color: '#3b82f6', icon: 'fa-download', num: 1, next: 'WORKSHOP' },
            WORKSHOP: { name: 'Workshop', color: '#f59e0b', icon: 'fa-wrench', num: 2, next: 'PREP' },
            PREP: { name: 'Prep', color: '#8b5cf6', icon: 'fa-spray-can', num: 3, next: 'READY' },
            READY: { name: 'Ready', color: '#10b981', icon: 'fa-check-circle', num: 4, next: 'ADVERTISED' },
            ADVERTISED: { name: 'Advertised', color: '#06b6d4', icon: 'fa-bullhorn', num: 5, next: 'SOLD' },
            SOLD: { name: 'Sold', color: '#64748b', icon: 'fa-check', num: 6, next: null }
        };

        let allVehicles = [];
        let stuckVehicles = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize VehicleStore
            VehicleStore.init();
            
            // Load data
            loadData();
            
            // Initialize search
            initQuickSearch();
            initGlobalSearch();
            
            // Render all
            renderAll();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshOperations, 30000);
            
            // Listen for updates from other pages
            window.addEventListener('vehicleUpdated', function(e) {
                refreshOperations();
            });
        });

        function loadData() {
            allVehicles = VehicleStore.getAll();
            
            // Identify stuck vehicles (>7 days in current stage)
            stuckVehicles = allVehicles.filter(v => {
                const days = VehicleStore.getDaysInStage(v);
                return days > 7 && v.stage !== 'SOLD';
            });
            
            // Show alert if stuck vehicles exist
            const alertBanner = document.getElementById('alertBanner');
            if (stuckVehicles.length > 0) {
                alertBanner.style.display = 'flex';
                document.getElementById('alertMessage').textContent = 
                    `${stuckVehicles.length} vehicle${stuckVehicles.length > 1 ? 's have' : ' has'} been stuck for over 7 days`;
            } else {
                alertBanner.style.display = 'none';
            }
        }

        function renderAll() {
            renderPipeline();
            renderWorkshopQueue();
            renderStaffWorkload();
            renderReadyToAd();
            updateHeaderStats();
            updateAvgTimes();
        }

        function renderPipeline() {
            const stageContainers = {
                INTAKE: document.getElementById('intakeVehicles'),
                WORKSHOP: document.getElementById('workshopVehicles'),
                PREP: document.getElementById('prepVehicles'),
                READY: document.getElementById('readyVehicles'),
                ADVERTISED: document.getElementById('advertisedVehicles')
            };
            
            const stageCounts = { INTAKE: 0, WORKSHOP: 0, PREP: 0, READY: 0, ADVERTISED: 0 };
            
            // Clear containers
            Object.values(stageContainers).forEach(el => el.innerHTML = '');
            
            // Sort vehicles by days in stage (oldest first)
            const sortedVehicles = [...allVehicles].sort((a, b) => 
                VehicleStore.getDaysInStage(b) - VehicleStore.getDaysInStage(a)
            );
            
            sortedVehicles.forEach(vehicle => {
                if (!stageContainers[vehicle.stage]) return;
                
                const days = VehicleStore.getDaysInStage(vehicle);
                const isStuck = days > 7;
                const isWarning = days > 5;
                
                stageCounts[vehicle.stage]++;
                
                const card = document.createElement('div');
                card.className = `vehicle-card ${isStuck ? 'alert' : ''} ${isWarning ? 'warning' : ''}`;
                card.onclick = () => openVehicleModal(vehicle);
                
                card.innerHTML = `
                    <div class="vehicle-reg">${vehicle.registration}</div>
                    <div class="vehicle-info">${vehicle.make} ${vehicle.model}</div>
                    <div class="vehicle-meta">
                        <span class="vehicle-days ${isStuck ? 'danger' : isWarning ? 'warning' : 'normal'}">
                            ${days}d
                        </span>
                        <div class="vehicle-assignee">
                            <i class="fas fa-user-circle"></i>
                            <span>${vehicle.assignedTo?.split(' ')[0] || 'Unassigned'}</span>
                        </div>
                    </div>
                `;
                
                stageContainers[vehicle.stage].appendChild(card);
            });
            
            // Update counts
            Object.keys(stageCounts).forEach(stage => {
                const el = document.getElementById(`count${stage.charAt(0) + stage.slice(1).toLowerCase()}`);
                if (el) el.textContent = stageCounts[stage];
            });
        }

        function renderWorkshopQueue() {
            const workshopVehicles = allVehicles.filter(v => v.stage === 'WORKSHOP');
            const container = document.getElementById('workshopQueue');
            
            if (workshopVehicles.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--cy-text-muted);">No active workshop jobs</div>';
                return;
            }
            
            container.innerHTML = workshopVehicles.map(v => {
                const days = VehicleStore.getDaysInStage(v);
                const isUrgent = days > 7;
                
                return `
                    <div class="job-row ${isUrgent ? 'urgent' : ''}" onclick="openVehicleModalById('${v.stockNo}')">
                        <div class="job-vehicle">
                            <div class="job-reg">${v.registration}</div>
                            <div class="job-desc">${v.make} ${v.model} • ${v.assignedTo}</div>
                        </div>
                        <div class="job-mechanic">
                            <div class="mechanic-avatar">${v.assignedTo?.charAt(0) || '?'}</div>
                            <span class="mechanic-name">${v.assignedTo?.split(' ')[0] || 'Unassigned'}</span>
                        </div>
                        <div class="job-time">
                            <div class="time-elapsed ${isUrgent ? 'text-red-500' : ''}">${days}d</div>
                            <div class="time-label">in stage</div>
                        </div>
                        <div class="job-actions" onclick="event.stopPropagation()">
                            <button class="job-btn" onclick="advanceVehicle('${v.stockNo}')" title="Complete & Move">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="job-btn" onclick="window.location.href='./workflow/stages/stage-2-workshop.html?stock=${v.stockNo}'" title="Open Form">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderStaffWorkload() {
            const staff = VehicleStore.getStaff();
            const container = document.getElementById('staffWorkload');
            
            container.innerHTML = staff.map(person => {
                const count = allVehicles.filter(v => v.assignedTo === person.name && v.stage !== 'SOLD').length;
                return `
                    <div class="workload-item">
                        <div class="workload-name">${person.name.split(' ')[0]}</div>
                        <div class="workload-count">${count}</div>
                        <div class="workload-label">vehicles</div>
                    </div>
                `;
            }).join('');
            
            // Update capacity bar
            const totalStaff = staff.length;
            const avgLoad = totalStaff > 0 ? allVehicles.filter(v => v.stage !== 'SOLD').length / totalStaff : 0;
            const capacityPercent = Math.min(100, Math.round((avgLoad / 8) * 100)); // Assume 8 is max load
            
            document.getElementById('capacityBar').style.width = capacityPercent + '%';
            document.getElementById('capacityText').textContent = capacityPercent + '%';
        }

        function renderReadyToAd() {
            const readyVehicles = allVehicles.filter(v => v.stage === 'READY');
            const container = document.getElementById('readyToAdGrid');
            
            if (readyVehicles.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--cy-text-muted);">No vehicles ready for advertising</div>';
                return;
            }
            
            container.innerHTML = readyVehicles.map(v => `
                <div class="ready-card" onclick="openVehicleModal(${JSON.stringify(v).replace(/"/g, '&quot;')})">
                    <div class="ready-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                    <div class="ready-info">
                        <div class="ready-reg">${v.registration}</div>
                        <div class="ready-status">${v.make} ${v.model}</div>
                    </div>
                    <button class="ready-action" onclick="event.stopPropagation(); advertiseVehicle('${v.stockNo}')">
                        Advertise
                    </button>
                </div>
            `).join('');
        }

        function updateHeaderStats() {
            const active = allVehicles.filter(v => v.stage !== 'SOLD').length;
            const workshop = allVehicles.filter(v => v.stage === 'WORKSHOP').length;
            const ready = allVehicles.filter(v => v.stage === 'READY').length;
            
            animateValue('totalActiveVehicles', active, '');
            animateValue('workshopLoad', workshop, '');
            animateValue('readyToAdvertise', ready, '');
        }

        function updateAvgTimes() {
            const stages = ['INTAKE', 'WORKSHOP', 'PREP'];
            stages.forEach(stage => {
                const vehicles = allVehicles.filter(v => v.stage === stage);
                const avg = vehicles.length > 0 
                    ? Math.round(vehicles.reduce((sum, v) => sum + VehicleStore.getDaysInStage(v), 0) / vehicles.length)
                    : 0;
                const el = document.getElementById(`avg${stage.charAt(0) + stage.slice(1).toLowerCase()}Time`);
                if (el) el.textContent = `Avg: ${avg} days`;
            });
        }

        function initQuickSearch() {
            const input = document.getElementById('quickSearch');
            const results = document.getElementById('quickSearchResults');
            
            let searchTimeout;
            
            input.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    results.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    const vehicles = VehicleStore.search(query);
                    showQuickResults(vehicles, results, input);
                }, 200);
            });
            
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !results.contains(e.target)) {
                    results.style.display = 'none';
                }
            });
        }

        function showQuickResults(vehicles, resultsDiv, input) {
            if (vehicles.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 12px; color: #64748b; font-size: 13px;">No vehicles found</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            resultsDiv.innerHTML = vehicles.slice(0, 5).map(v => {
                const stage = stages[v.stage];
                return `
                    <div class="search-result-item" onclick="selectQuickVehicle('${v.stockNo}')">
                        <div class="result-stage-icon" style="background: ${stage?.color || '#3b82f6'};">
                            <i class="fas ${stage?.icon || 'fa-car'}"></i>
                        </div>
                        <div class="result-info">
                            <div class="result-reg">${v.registration}</div>
                            <div class="result-details">${v.make} ${v.model} • ${stage?.name || v.stage} • ${v.assignedTo}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.style.display = 'block';
        }

        function selectQuickVehicle(stockNo) {
            const vehicle = VehicleStore.get(stockNo);
            if (!vehicle) return;
            
            document.getElementById('quickSearchResults').style.display = 'none';
            document.getElementById('quickSearch').value = vehicle.registration;
            
            const div = document.getElementById('selectedVehicle');
            div.style.display = 'block';
            const stage = stages[vehicle.stage];
            
            div.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(59,130,246,0.1); border-radius: 8px; border: 1px solid rgba(59,130,246,0.2);">
                    <div style="width: 40px; height: 40px; background: ${stage?.color || '#3b82f6'}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                        <i class="fas ${stage?.icon || 'fa-car'}"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: #f8fafc; font-size: 14px;">${vehicle.registration}</div>
                        <div style="font-size: 11px; color: #94a3b8;">${vehicle.make} ${vehicle.model} | ${stage?.name || vehicle.stage}</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openVehicleModalById('${vehicle.stockNo}')" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">View</button>
                        ${vehicle.stage !== 'SOLD' ? `
                            <button onclick="advanceVehicle('${vehicle.stockNo}')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">Advance</button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function initGlobalSearch() {
            const input = document.getElementById('globalSearch');
            const results = document.getElementById('globalSearchResults');
            
            let searchTimeout;
            
            input.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    results.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    const vehicles = VehicleStore.search(query);
                    showGlobalResults(vehicles, results);
                }, 200);
            });
            
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !results.contains(e.target)) {
                    results.style.display = 'none';
                }
            });
        }

        function showGlobalResults(vehicles, resultsDiv) {
            if (vehicles.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 12px; color: #64748b; font-size: 13px;">No vehicles found</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            resultsDiv.innerHTML = vehicles.slice(0, 6).map(v => {
                const stage = stages[v.stage];
                return `
                    <div onclick="goToVehicle('${v.stockNo}', '${v.stage}')" style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.06); cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 32px; height: 32px; background: ${stage?.color || '#3b82f6'}; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                <i class="fas ${stage?.icon || 'fa-car'}"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #f8fafc; font-size: 13px;">${v.registration}</div>
                                <div style="font-size: 11px; color: #64748b;">${v.make} ${v.model} | ${stage?.name || v.stage}</div>
                            </div>
                            <i class="fas fa-chevron-right" style="color: #64748b; font-size: 10px;"></i>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.style.display = 'block';
        }

        function goToVehicle(stockNo, stage) {
            const stageNum = stages[stage]?.num || 1;
            const stageName = stage.toLowerCase();
            window.location.href = `./workflow/stages/stage-${stageNum}-${stageName}.html?stock=${stockNo}`;
        }

        function openVehicleModal(vehicle) {
            document.getElementById('modalTitle').textContent = `${vehicle.registration} - ${vehicle.make} ${vehicle.model}`;
            
            const days = VehicleStore.getDaysInStage(vehicle);
            const stage = stages[vehicle.stage];
            const history = VehicleStore.getHistory(vehicle.stockNo);
            
            let historyHtml = '';
            if (history && history.length > 0) {
                historyHtml = history.map(h => {
                    const histStage = stages[h.stage] || stages[h.fromStage] || stages[h.toStage];
                    return `
                        <div class="timeline-item" style="--stage-color: ${histStage?.color || '#3b82f6'}">
                            <div class="timeline-date">${new Date(h.timestamp).toLocaleDateString('en-GB')}</div>
                            <div class="timeline-action">${histStage?.name || h.stage} ${h.action ? `(${h.action})` : ''}</div>
                            <div class="timeline-person">by ${h.staff}</div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('modalBody').innerHTML = `
                <div style="display: grid; gap: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div style="background: var(--cy-bg-tertiary); padding: 16px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 11px; color: var(--cy-text-muted); margin-bottom: 4px;">Current Stage</div>
                            <div style="font-family: 'Space Grotesk'; font-size: 16px; font-weight: 700; color: ${stage?.color || '#3b82f6'};">
                                ${stage?.name || vehicle.stage}
                            </div>
                        </div>
                        <div style="background: var(--cy-bg-tertiary); padding: 16px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 11px; color: var(--cy-text-muted); margin-bottom: 4px;">Days in Stage</div>
                            <div style="font-family: 'Space Grotesk'; font-size: 16px; font-weight: 700; color: ${days > 7 ? '#dc2626' : days > 5 ? '#f59e0b' : '#10b981'};">
                                ${days} days
                            </div>
                        </div>
                        <div style="background: var(--cy-bg-tertiary); padding: 16px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 11px; color: var(--cy-text-muted); margin-bottom: 4px;">Assigned To</div>
                            <div style="font-family: 'Space Grotesk'; font-size: 16px; font-weight: 700; color: var(--cy-text-primary);">
                                ${vehicle.assignedTo?.split(' ')[0] || 'Unassigned'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                        <div><strong>Stock No:</strong> ${vehicle.stockNo}</div>
                        <div><strong>Location:</strong> ${vehicle.location || 'Unknown'}</div>
                        <div><strong>Year:</strong> ${vehicle.year || 'N/A'}</div>
                        <div><strong>Mileage:</strong> ${vehicle.mileage?.toLocaleString() || 'N/A'}</div>
                        <div><strong>Color:</strong> ${vehicle.color || 'N/A'}</div>
                        <div><strong>Fuel:</strong> ${vehicle.fuel || 'N/A'}</div>
                    </div>
                    
                    <div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--cy-text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Stage History</div>
                        <div class="timeline">
                            ${historyHtml || '<div style="color: var(--cy-text-muted); font-size: 13px;">No history available</div>'}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; padding-top: 16px; border-top: 1px solid var(--cy-border);">
                        ${vehicle.stage !== 'SOLD' ? `
                            <button onclick="advanceVehicle('${vehicle.stockNo}'); closeModal();" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-arrow-right"></i> Advance to ${stages[stage?.next]?.name || 'Next'}
                            </button>
                        ` : ''}
                        <button onclick="window.location.href='./workflow/stages/stage-${stage?.num}-${vehicle.stage.toLowerCase()}.html?stock=${vehicle.stockNo}'" style="padding: 12px 20px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer;">
                            Open Form
                        </button>
                        <button onclick="reassignVehicle('${vehicle.stockNo}');" style="padding: 12px 20px; background: var(--cy-bg-tertiary); border: 1px solid var(--cy-border); color: var(--cy-text-primary); border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                            Reassign
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('vehicleModal').classList.add('active');
        }

        function openVehicleModalById(stockNo) {
            const vehicle = VehicleStore.get(stockNo);
            if (vehicle) openVehicleModal(vehicle);
        }

        function closeModal() {
            document.getElementById('vehicleModal').classList.remove('active');
        }

        function advanceVehicle(stockNo) {
            const result = VehicleStore.advance(stockNo, {
                staff: 'Current User',
                notes: 'Advanced from Operations dashboard'
            });
            
            if (result.success) {
                alert(`Vehicle advanced to ${stages[result.vehicle.stage]?.name || result.vehicle.stage}`);
                refreshOperations();
            } else {
                alert('Error: ' + result.error);
            }
        }

        function advertiseVehicle(stockNo) {
            const result = VehicleStore.advance(stockNo, {
                staff: 'Current User',
                notes: 'Sent to advertising'
            });
            
            if (result.success) {
                alert('Vehicle sent to advertising!');
                refreshOperations();
            }
        }

        function advertiseAll() {
            const ready = allVehicles.filter(v => v.stage === 'READY');
            if (ready.length === 0) {
                alert('No vehicles ready to advertise');
                return;
            }
            
            if (confirm(`Advertise all ${ready.length} ready vehicles?`)) {
                ready.forEach(v => {
                    VehicleStore.advance(v.stockNo, { staff: 'System', notes: 'Bulk advertise' });
                });
                refreshOperations();
                alert(`${ready.length} vehicles sent to advertising`);
            }
        }

        function reassignVehicle(stockNo) {
            const staff = VehicleStore.getStaff();
            const names = staff.map(s => s.name);
            const newAssignee = prompt(`Reassign to:\n${names.join('\n')}\n\nCurrent: ${VehicleStore.get(stockNo)?.assignedTo}`);
            
            if (newAssignee && names.includes(newAssignee)) {
                VehicleStore.update(stockNo, { assignedTo: newAssignee });
                refreshOperations();
            }
        }

        function viewStuckVehicles() {
            if (stuckVehicles.length === 0) return;
            const list = stuckVehicles.map(v => `${v.registration} (${v.stage}, ${VehicleStore.getDaysInStage(v)} days)`).join('\n');
            alert(`Stuck Vehicles:\n\n${list}`);
        }

        function refreshOperations() {
            loadData();
            renderAll();
            
            const btn = document.querySelector('button[onclick="refreshOperations()"] i');
            if (btn) {
                btn.style.animation = 'spin 1s linear';
                setTimeout(() => btn.style.animation = '', 1000);
            }
        }

        function animateValue(id, value, prefix) {
            const el = document.getElementById(id);
            const current = parseInt(el.textContent) || 0;
            const diff = value - current;
            if (diff === 0) return;
            
            const steps = 20;
            const increment = diff / steps;
            let step = 0;
            
            const timer = setInterval(() => {
                step++;
                const newVal = Math.round(current + (increment * step));
                el.textContent = prefix + newVal;
                if (step >= steps) clearInterval(timer);
            }, 30);
        }

        function logout() {
            localStorage.removeItem('capeye_session');
            window.location.href = './login.html';
        }

        // Close modal on outside click
        document.getElementById('vehicleModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>
</html>
