<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Pipeline | Capeye Auto Capital</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Papa Parse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --cy-bg-primary: #0a0f1c;
            --cy-bg-secondary: #111827;
            --cy-bg-tertiary: #1f2937;
            --cy-border: #374151;
            --cy-border-hover: #4b5563;
            --cy-text-primary: #f9fafb;
            --cy-text-secondary: #d1d5db;
            --cy-text-muted: #9ca3af;
            --cy-accent-blue: #3b82f6;
            --cy-accent-blue-soft: rgba(59, 130, 246, 0.15);
            --cy-accent-green: #10b981;
            --cy-accent-green-soft: rgba(16, 185, 129, 0.15);
            --cy-accent-orange: #f59e0b;
            --cy-accent-orange-soft: rgba(245, 158, 11, 0.15);
            --cy-accent-red: #ef4444;
            --cy-accent-purple: #8b5cf6;
            --cy-radius-sm: 6px;
            --cy-radius-md: 8px;
            --cy-radius-lg: 12px;
            --cy-radius-xl: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cy-bg-primary);
            color: var(--cy-text-primary);
            line-height: 1.5;
        }

        /* Header */
        .cy-header {
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--cy-border);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .cy-header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cy-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .cy-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--cy-accent-blue), #8b5cf6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
        }

        .cy-brand-text h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--cy-text-primary);
            line-height: 1.2;
        }

        .cy-brand-text span {
            font-size: 11px;
            color: var(--cy-text-muted);
        }

        .nav-menu {
            display: flex;
            gap: 8px;
        }

        .nav-item {
            padding: 8px 16px;
            color: var(--cy-text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            border-radius: var(--cy-radius-md);
            transition: all 0.15s ease;
        }

        .nav-item:hover {
            color: var(--cy-text-primary);
            background: var(--cy-bg-tertiary);
        }

        .nav-item.active {
            color: var(--cy-accent-blue);
            background: var(--cy-accent-blue-soft);
        }

        /* Main Container */
        .cy-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Pipeline Header */
        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .pipeline-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 24px;
            font-weight: 700;
        }

        .pipeline-stats {
            display: flex;
            gap: 24px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--cy-accent-blue);
        }

        .stat-label {
            font-size: 12px;
            color: var(--cy-text-muted);
            text-transform: uppercase;
        }

        /* Stage Pipeline */
        .stage-pipeline {
            background: var(--cy-bg-secondary);
            border: 1px solid var(--cy-border);
            border-radius: var(--cy-radius-xl);
            padding: 20px;
            margin-bottom: 24px;
            overflow-x: auto;
        }

        .pipeline-stages {
            display: flex;
            justify-content: space-between;
            min-width: 1000px;
            position: relative;
        }

        .pipeline-stages::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: var(--cy-border);
            z-index: 0;
        }

        .stage-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .stage-node:hover {
            transform: translateY(-2px);
        }

        .stage-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            border: 3px solid var(--cy-border);
            background: var(--cy-bg-tertiary);
            transition: all 0.3s;
        }

        .stage-node.active .stage-circle {
            background: var(--cy-accent-blue);
            border-color: var(--cy-accent-blue);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        .stage-node.complete .stage-circle {
            background: var(--cy-accent-green);
            border-color: var(--cy-accent-green);
        }

        .stage-node.pending .stage-circle {
            color: var(--cy-text-muted);
        }

        .stage-name {
            font-size: 11px;
            color: var(--cy-text-muted);
            text-align: center;
            white-space: nowrap;
        }

        .stage-node.active .stage-name {
            color: var(--cy-accent-blue);
            font-weight: 600;
        }

        /* Vehicle Cards */
        .vehicles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .vehicle-card {
            background: var(--cy-bg-secondary);
            border: 1px solid var(--cy-border);
            border-radius: var(--cy-radius-xl);
            overflow: hidden;
            transition: all 0.3s;
        }

        .vehicle-card:hover {
            border-color: var(--cy-border-hover);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .vehicle-header {
            padding: 16px;
            border-bottom: 1px solid var(--cy-border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .vehicle-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .vehicle-meta {
            font-size: 13px;
            color: var(--cy-text-muted);
        }

        .vehicle-stock {
            background: var(--cy-bg-tertiary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            font-family: monospace;
        }

        .vehicle-stages {
            padding: 16px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
        }

        .stage-box {
            min-width: 60px;
            height: 60px;
            background: var(--cy-bg-tertiary);
            border: 2px solid var(--cy-border);
            border-radius: var(--cy-radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: default;
            transition: all 0.2s;
        }

        .stage-box i {
            font-size: 16px;
            color: var(--cy-text-muted);
        }

        .stage-box span {
            font-size: 10px;
            color: var(--cy-text-muted);
        }

        .stage-box.pending {
            opacity: 0.5;
        }

        .stage-box.active {
            background: var(--cy-accent-blue-soft);
            border-color: var(--cy-accent-blue);
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        .stage-box.active i,
        .stage-box.active span {
            color: var(--cy-accent-blue);
        }

        .stage-box.complete {
            background: var(--cy-accent-green-soft);
            border-color: var(--cy-accent-green);
            cursor: pointer;
        }

        .stage-box.complete i,
        .stage-box.complete span {
            color: var(--cy-accent-green);
        }

        .stage-box:hover.active,
        .stage-box:hover.complete {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
        }

        .vehicle-actions {
            padding: 16px;
            border-top: 1px solid var(--cy-border);
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--cy-radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
        }

        .btn-primary {
            background: var(--cy-accent-blue);
            color: white;
            flex: 1;
            justify-content: center;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: var(--cy-bg-tertiary);
            color: var(--cy-text-secondary);
            border: 1px solid var(--cy-border);
        }

        .btn-secondary:hover {
            border-color: var(--cy-border-hover);
            color: var(--cy-text-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px;
            color: var(--cy-text-muted);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Loading */
        .loading-spinner {
            display: flex;
            justify-content: center;
            padding: 40px;
        }

        .spinner-small {
            width: 32px;
            height: 32px;
            border: 3px solid var(--cy-border);
            border-top-color: var(--cy-accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            right: 24px;
            padding: 16px 24px;
            background: var(--cy-bg-secondary);
            border: 1px solid var(--cy-border);
            border-radius: var(--cy-radius-lg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 100;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.show { display: flex; }

        .notification.success {
            border-color: var(--cy-accent-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .notification.error {
            border-color: var(--cy-accent-red);
            background: rgba(239, 68, 68, 0.1);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="cy-header">
        <div class="cy-header-content">
            <a href="../index.html" class="cy-brand">
                <div class="cy-logo">AC</div>
                <div class="cy-brand-text">
                    <h1>CAPEYE</h1>
                    <span>Auto Capital Intelligence</span>
                </div>
            </a>
            
            <nav class="nav-menu">
                <a href="../index.html" class="nav-item">Dashboard</a>
                <a href="../operations.html" class="nav-item">Operations</a>
                <a href="../inventory.html" class="nav-item">Inventory</a>
                <a href="../workflow.html" class="nav-item active">Workflow</a>
                <a href="../analytics.html" class="nav-item">Analytics</a>
            </nav>

            <div style="display: flex; gap: 12px; align-items: center;">
                <button onclick="refreshData()" class="btn-secondary">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <a href="../login.html" class="btn-secondary">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="cy-container">
        <!-- Pipeline Header -->
        <div class="pipeline-header">
            <div>
                <h1 class="pipeline-title">Workflow Pipeline</h1>
                <p style="color: var(--cy-text-muted); margin-top: 4px;">Track vehicles through 12-stage preparation process</p>
            </div>
            <div class="pipeline-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalVehicles">0</div>
                    <div class="stat-label">In Pipeline</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="activeVehicles">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completedToday">0</div>
                    <div class="stat-label">Today</div>
                </div>
            </div>
        </div>

        <!-- Stage Pipeline Overview -->
        <div class="stage-pipeline">
            <div class="pipeline-stages" id="pipelineStages">
                <!-- Stages rendered by JS -->
            </div>
        </div>

        <!-- Vehicles Grid -->
        <div id="vehiclesContainer">
            <div class="loading-spinner">
                <div class="spinner-small"></div>
            </div>
        </div>
    </main>

    <!-- Notification -->
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText"></span>
    </div>

    <script>
        // Stage URL mapping - CORRECT PATHS to stage forms
        const stageUrls = {
            1: './stages/stage-1-intake.html',
            2: './stages/stage-2-bodywork.html',
            3: './stages/stage-3-paint.html',
            4: './stages/stage-4-legal.html',
            5: './stages/stage-5-mechanical.html',
            6: './stages/stage-6-external.html',
            7: './stages/stage-7-valeting.html',
            8: './stages/stage-8-faults.html',
            9: './stages/stage-9-advertising.html',
            10: './stages/stage-10-delivery.html',
            11: './stages/stage-11-accounts.html',
            12: './stages/stage-12-management.html'
        };

        // Stage definitions
        const stages = [
            { num: 1, name: 'Intake', icon: 'fa-clipboard-check', color: 'blue' },
            { num: 2, name: 'Bodywork', icon: 'fa-car-crash', color: 'orange' },
            { num: 3, name: 'Paint', icon: 'fa-paint-roller', color: 'purple' },
            { num: 4, name: 'Legal', icon: 'fa-file-contract', color: 'indigo' },
            { num: 5, name: 'Mechanical', icon: 'fa-wrench', color: 'red' },
            { num: 6, name: 'External', icon: 'fa-lightbulb', color: 'yellow' },
            { num: 7, name: 'Valeting', icon: 'fa-spray-can', color: 'green' },
            { num: 8, name: 'Faults', icon: 'fa-exclamation-triangle', color: 'orange' },
            { num: 9, name: 'Advertising', icon: 'fa-bullhorn', color: 'blue' },
            { num: 10, name: 'Delivery', icon: 'fa-handshake', color: 'green' },
            { num: 11, name: 'Accounts', icon: 'fa-calculator', color: 'slate' },
            { num: 12, name: 'Management', icon: 'fa-user-tie', color: 'indigo' }
        ];

        let allVehicles = [];
        let vehicleProfiles = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderPipelineStages();
            
            // Check for workflow updates from other pages
            window.addEventListener('storage', function(e) {
                if (e.key === 'capeye_workflow_update') {
                    loadData();
                }
            });
        });

        // Load all data
        async function loadData() {
            try {
                // Load vehicle profiles from localStorage
                const profiles = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('capeye_vehicle_')) {
                        const stockNo = key.replace('capeye_vehicle_', '');
                        profiles[stockNo] = JSON.parse(localStorage.getItem(key));
                    }
                }
                vehicleProfiles = profiles;

                // Load CSV data
                const response = await fetch('../Auto Capital - Stock List-639068391990284525.csv');
                const csv = await response.text();
                
                Papa.parse(csv, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allVehicles = results.data.map(normalizeVehicle).filter(v => v.stockNo);
                        mergeVehicleData();
                        renderVehicles();
                        updateStats();
                    }
                });
            } catch (error) {
                showNotification('Error loading data: ' + error.message, 'error');
            }
        }

        function normalizeVehicle(row) {
            const getValue = (keys) => {
                for (let key of keys) {
                    if (row[key] !== undefined && row[key] !== '') return row[key];
                }
                return '';
            };

            return {
                stockNo: getValue(['Stock No', 'StockNo', 'Stock Number', 'StockNo.']),
                registration: getValue(['Registration', 'Reg', 'Reg No', 'RegNo']),
                make: getValue(['Make', 'Manufacturer', 'Brand']),
                model: getValue(['Model', 'Model Name']),
                variant: getValue(['Variant', 'Trim', 'Spec']),
                year: getValue(['Year', 'Year Reg', 'Reg Year']),
                colour: getValue(['Colour', 'Color', 'Body Colour']),
                location: getValue(['Location', 'Vehicle Location', 'Current Location']),
                status: getValue(['Status', 'Vehicle Status', 'Stock Status']),
                dateInStock: getValue(['Date In Stock', 'DateInStock', 'In Stock Date']),
                costPrice: parseFloat(getValue(['Cost Price', 'CostPrice', 'Cost'])?.toString().replace(/[£,]/g, '')) || 0,
                retailPrice: parseFloat(getValue(['Retail Price', 'RetailPrice', 'Retail'])?.toString().replace(/[£,]/g, '')) || 0,
                fuelType: getValue(['Fuel Type', 'Fuel', 'FuelType']),
                transmission: getValue(['Transmission', 'Gearbox', 'Trans']),
                mileage: getValue(['Mileage', 'Miles', 'Odometer']),
                body: getValue(['Body', 'Body Type', 'Body Style']),
                mot: getValue(['MOT', 'MOT Date', 'MOT Expiry'])
            };
        }

        function mergeVehicleData() {
            allVehicles.forEach(vehicle => {
                const profile = vehicleProfiles[vehicle.stockNo];
                if (profile) {
                    vehicle.currentStage = profile.currentStage || 1;
                    vehicle.stageHistory = profile.stageHistory || [];
                    vehicle.lastUpdated = profile.lastUpdated;
                } else {
                    vehicle.currentStage = 1; // Default to intake
                    vehicle.stageHistory = [];
                }
            });
        }

        function renderPipelineStages() {
            const container = document.getElementById('pipelineStages');
            container.innerHTML = stages.map(stage => `
                <div class="stage-node pending" id="stage-node-${stage.num}">
                    <div class="stage-circle">${stage.num}</div>
                    <div class="stage-name">${stage.name}</div>
                </div>
            `).join('');
        }

        function renderVehicles() {
            const container = document.getElementById('vehiclesContainer');
            
            // Filter vehicles that have started workflow (have profiles) or are in stock
            const workflowVehicles = allVehicles.filter(v => 
                vehicleProfiles[v.stockNo] || v.status === 'In Stock' || v.status === 'In Transit'
            );

            if (workflowVehicles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>No Vehicles in Workflow</h3>
                        <p>Start by selecting a vehicle from inventory to begin intake.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = workflowVehicles.map(vehicle => {
                const currentStage = vehicle.currentStage || 1;
                const isComplete = currentStage > 12;
                
                return `
                    <div class="vehicle-card" data-stock="${vehicle.stockNo}">
                        <div class="vehicle-header">
                            <div class="vehicle-info">
                                <h3>${vehicle.make} ${vehicle.model}</h3>
                                <div class="vehicle-meta">
                                    ${vehicle.year} • ${vehicle.fuelType} • ${vehicle.transmission} • ${vehicle.colour || 'Unknown'}
                                </div>
                            </div>
                            <div>
                                <div class="vehicle-stock">${vehicle.stockNo}</div>
                                <div style="font-size: 11px; color: var(--cy-text-muted); margin-top: 4px; text-align: center;">
                                    ${vehicle.registration || 'No Reg'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="vehicle-stages">
                            ${renderStageBoxes(vehicle)}
                        </div>
                        
                        <div class="vehicle-actions">
                            ${isComplete ? `
                                <button onclick="viewVehicle('${vehicle.stockNo}')" class="btn btn-secondary">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <span style="color: var(--cy-accent-green); display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-check-circle"></i> Complete
                                </span>
                            ` : `
                                <button onclick="startInspection('${vehicle.stockNo}')" class="btn btn-primary">
                                    <i class="fas fa-play"></i> Start Inspection
                                </button>
                                <button onclick="viewVehicle('${vehicle.stockNo}')" class="btn btn-secondary">
                                    <i class="fas fa-eye"></i>
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderStageBoxes(vehicle) {
            const currentStage = vehicle.currentStage || 1;
            
            return stages.map(stage => {
                let status = 'pending';
                if (stage.num < currentStage) status = 'complete';
                else if (stage.num === currentStage) status = 'active';
                
                const clickable = status !== 'pending';
                
                return `
                    <div class="stage-box ${status}" 
                         ${clickable ? `onclick="openStageForm(${stage.num}, '${vehicle.stockNo}')"` : ''}
                         title="${stage.name}: ${status}">
                        <i class="fas ${stage.icon}"></i>
                        <span>${stage.num}</span>
                    </div>
                `;
            }).join('');
        }

        // Open specific stage form for a vehicle - FIXED PATH
        function openStageForm(stageNum, stockNo) {
            const url = stageUrls[stageNum];
            if (url) {
                window.location.href = `${url}?stock=${stockNo}`;
            } else {
                showNotification('Stage form not found', 'error');
            }
        }

        // Start new inspection (Stage 1) - FIXED TO USE CORRECT URL
        function startInspection(stockNo) {
            openStageForm(1, stockNo);
        }

        // Continue/Edit existing stage
        function continueInspection(stockNo, currentStage) {
            openStageForm(currentStage, stockNo);
        }

        function viewVehicle(stockNo) {
            // Could open a detail modal or navigate to vehicle detail page
            showNotification(`Viewing vehicle ${stockNo}`, 'success');
        }

        function updateStats() {
            const total = allVehicles.filter(v => vehicleProfiles[v.stockNo]).length;
            const active = allVehicles.filter(v => {
                const stage = v.currentStage || 1;
                return stage > 1 && stage <= 12;
            }).length;
            
            // Count completed today
            const today = new Date().toDateString();
            const completedToday = allVehicles.filter(v => {
                const history = v.stageHistory || [];
                return history.some(h => {
                    const completed = new Date(h.completedAt);
                    return completed.toDateString() === today;
                });
            }).length;

            document.getElementById('totalVehicles').textContent = total;
            document.getElementById('activeVehicles').textContent = active;
            document.getElementById('completedToday').textContent = completedToday;
        }

        function refreshData() {
            document.getElementById('vehiclesContainer').innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-small"></div>
                </div>
            `;
            loadData();
            showNotification('Data refreshed', 'success');
        }

        function showNotification(message, type) {
            const notif = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            
            notif.className = `notification ${type} show`;
            text.textContent = message;
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
