<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capeye - Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-badge { @apply px-2 py-1 rounded-full text-xs font-medium; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Auth Check -->
    <script src="js/auth.js"></script>
    <script>
        if (!Auth.isAuthenticated()) {
            window.location.href = 'login.html';
        }
    </script>

    <!-- Header -->
    <header class="bg-slate-900 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="dashboard.html" class="flex items-center hover:opacity-80 transition">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <h1 class="text-xl font-bold">Capeye</h1>
                        </div>
                    </a>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-medium user-name">Loading...</p>
                        <p class="text-xs text-slate-400 user-role">Loading...</p>
                    </div>
                    <button class="logout-btn p-2 rounded-lg hover:bg-slate-800 transition" title="Logout">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex items-center text-sm text-slate-500 mb-2">
                <a href="dashboard.html" class="hover:text-blue-600">Dashboard</a>
                <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <span class="text-slate-900">Inventory</span>
            </div>
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Vehicle Inventory</h2>
                    <p class="text-slate-600 mt-1">Manage and track all vehicles in stock.</p>
                </div>
                <div class="flex space-x-3">
                    <a href="import.html" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-medium rounded-lg transition">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Import CSV
                    </a>
                </div>
            </div>
        </div>

        <!-- Import Status Banner -->
        <div id="importStatus" class="hidden mb-6 p-4 rounded-lg border">
            <!-- Populated by JS -->
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Search</label>
                    <input type="text" id="searchInput" placeholder="Reg, Make, Model..." 
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Location</label>
                    <select id="locationFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Locations</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                    <select id="statusFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Statuses</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Make</label>
                    <select id="makeFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Makes</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <div class="text-sm text-slate-500">
                    Showing <span id="showingCount" class="font-medium text-slate-900">0</span> of <span id="totalCount" class="font-medium text-slate-900">0</span> vehicles
                </div>
                <button onclick="clearFilters()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Clear Filters</button>
            </div>
        </div>

        <!-- Inventory Table -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Registration</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Vehicle</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Location</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Days in Stock</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Cost Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Retail Price</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable" class="bg-white divide-y divide-slate-200">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="hidden p-12 text-center">
                <svg class="w-16 h-16 text-slate-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                </svg>
                <p class="text-slate-500 text-lg font-medium">No vehicles found</p>
                <p class="text-slate-400 text-sm mt-1">Import data or adjust your filters</p>
                <a href="import.html" class="inline-block mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-medium rounded-lg transition">Import Vehicles</a>
            </div>
        </div>

    </main>

    <script src="js/reference-data.js"></script>
    <script src="js/vehicle-store.js"></script>
    <script>
        // Current filtered data
        let currentData = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            Auth.updateUI();
            checkImportStatus();
            populateFilters();
            loadInventory();
            
            // Event listeners
            document.getElementById('searchInput').addEventListener('input', debounce(loadInventory, 300));
            document.getElementById('locationFilter').addEventListener('change', loadInventory);
            document.getElementById('statusFilter').addEventListener('change', loadInventory);
            document.getElementById('makeFilter').addEventListener('change', loadInventory);
        });

        function checkImportStatus() {
            const lastImport = localStorage.getItem('capeye_last_import');
            const banner = document.getElementById('importStatus');
            
            if (!lastImport) {
                banner.classList.remove('hidden');
                banner.className = 'mb-6 p-4 rounded-lg border bg-yellow-50 border-yellow-200';
                banner.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-yellow-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-yellow-900">No data imported yet</p>
                            <p class="text-sm text-yellow-700">Import your ClickDealer CSV to see vehicles</p>
                        </div>
                        <a href="import.html" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 text-white text-sm font-medium rounded-lg transition">Import Now</a>
                    </div>
                `;
                return;
            }
            
            const importDate = new Date(lastImport);
            const hoursSince = (new Date() - importDate) / (1000 * 60 * 60);
            
            if (hoursSince > 48) {
                banner.classList.remove('hidden');
                banner.className = 'mb-6 p-4 rounded-lg border bg-orange-50 border-orange-200';
                banner.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-orange-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-orange-900">Data is ${Math.floor(hoursSince / 24)} days old</p>
                            <p class="text-sm text-orange-700">Last import: ${importDate.toLocaleDateString()}</p>
                        </div>
                        <a href="import.html" class="px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white text-sm font-medium rounded-lg transition">Update Data</a>
                    </div>
                `;
            } else {
                banner.classList.remove('hidden');
                banner.className = 'mb-6 p-4 rounded-lg border bg-green-50 border-green-200';
                banner.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-green-900">Data up to date</p>
                            <p class="text-sm text-green-700">Last import: ${importDate.toLocaleString()}</p>
                        </div>
                    </div>
                `;
            }
        }

        function populateFilters() {
            // Populate from reference data
            ReferenceData.populateSelect('locationFilter', 'locations', { includeEmpty: true, emptyLabel: 'All Locations' });
            ReferenceData.populateSelect('statusFilter', 'statuses', { includeEmpty: true, emptyLabel: 'All Statuses' });
            ReferenceData.populateSelect('makeFilter', 'manufacturers', { includeEmpty: true, emptyLabel: 'All Makes' });
        }

        function loadInventory() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const location = document.getElementById('locationFilter').value;
            const status = document.getElementById('statusFilter').value;
            const make = document.getElementById('makeFilter').value;
            
            // Get all vehicles
            let vehicles = VehicleStore.getAll();
            
            // Apply filters
            if (search) {
                vehicles = vehicles.filter(v => 
                    (v.registration && v.registration.toLowerCase().includes(search)) ||
                    (v.make && v.make.toLowerCase().includes(search)) ||
                    (v.model && v.model.toLowerCase().includes(search)) ||
                    (v.colour && v.colour.toLowerCase().includes(search))
                );
            }
            
            if (location) {
                vehicles = vehicles.filter(v => v.location === location);
            }
            
            if (status) {
                vehicles = vehicles.filter(v => v.status === status);
            }
            
            if (make) {
                vehicles = vehicles.filter(v => v.make === make);
            }
            
            currentData = vehicles;
            
            // Update counts
            document.getElementById('showingCount').textContent = vehicles.length;
            document.getElementById('totalCount').textContent = VehicleStore.getAll().length;
            
            // Render table
            renderTable(vehicles);
        }

        function renderTable(vehicles) {
            const tbody = document.getElementById('inventoryTable');
            const emptyState = document.getElementById('emptyState');
            
            if (vehicles.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            tbody.innerHTML = vehicles.map(v => {
                const daysClass = v.daysInStock > 60 ? 'text-red-600 font-medium' : 
                                 v.daysInStock > 30 ? 'text-orange-600' : 'text-slate-600';
                
                const statusColors = {
                    'In Stock': 'bg-green-100 text-green-800',
                    'In Transit': 'bg-blue-100 text-blue-800',
                    'Reserved': 'bg-yellow-100 text-yellow-800',
                    'Sold': 'bg-slate-100 text-slate-800',
                    'Off-site R': 'bg-orange-100 text-orange-800'
                };
                
                return `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">
                            ${v.registration}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-slate-900">${v.make} ${v.model}</div>
                            <div class="text-sm text-slate-500">${v.variant || ''} ${v.year || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            ${v.location || '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[v.status] || 'bg-slate-100 text-slate-800'}">
                                ${v.status || 'Unknown'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${daysClass}">
                            ${v.daysInStock || 0} days
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            ${v.costPrice ? '£' + v.costPrice.toLocaleString() : '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            ${v.retailPrice ? '£' + v.retailPrice.toLocaleString() : '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewVehicle('${v.registration}')" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                            <button onclick="editVehicle('${v.registration}')" class="text-slate-600 hover:text-slate-900">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('locationFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('makeFilter').value = '';
            loadInventory();
        }

        function viewVehicle(registration) {
            alert('View vehicle: ' + registration);
            // TODO: Open vehicle detail modal or page
        }

        function editVehicle(registration) {
            alert('Edit vehicle: ' + registration);
            // TODO: Open vehicle edit modal or page
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
