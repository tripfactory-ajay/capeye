<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Live Status - CapEYE Auto Capital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .nav-link.active {
            background-color: #3B82F6;
            color: white !important;
        }
        .nav-link.active:hover {
            background-color: #2563EB;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .stage-badge {
            transition: all 0.2s ease;
        }
        .stage-badge:hover {
            transform: scale(1.05);
        }
        .table-row {
            transition: all 0.2s ease;
        }
        .table-row:hover {
            background-color: #F3F4F6;
        }
        .progress-bar {
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation Header -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg flex items-center justify-center shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">CapEYE</h1>
                            <p class="text-xs text-gray-500">Auto Capital Intelligence</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-1">
                    <a href="index.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200">Dashboard</a>
                    <a href="operations.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200">Operations</a>
                    <a href="inventory.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200">Inventory</a>
                    <a href="workflow.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200">Workflow</a>
                    <a href="analytics.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200">Analytics</a>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="refreshData()" class="p-2 rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-green-50 rounded-full border border-green-200">
                        <span class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></span>
                        <span class="text-xs font-medium text-green-700">Live</span>
                    </div>
                    <button onclick="logout()" class="p-2 rounded-lg text-gray-400 hover:text-red-600 hover:bg-red-50 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Vehicle Live Status</h1>
                    <p class="text-gray-600 mt-1">Real-time view of all vehicles in the workflow pipeline</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="window.location.href='workflow.html'" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Workflow View
                    </button>
                </div>
            </div>
        </div>

        <!-- Stage Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
            <div class="glass-panel rounded-lg p-3 cursor-pointer hover:shadow-md transition-shadow" onclick="filterByStage(1)">
                <p class="text-2xl font-bold text-yellow-600" id="count-stage-1">0</p>
                <p class="text-xs text-gray-600">Intake</p>
            </div>
            <div class="glass-panel rounded-lg p-3 cursor-pointer hover:shadow-md transition-shadow" onclick="filterByStage(2)">
                <p class="text-2xl font-bold text-orange-600" id="count-stage-2">0</p>
                <p class="text-xs text-gray-600">Bodywork</p>
            </div>
            <div class="glass-panel rounded-lg p-3 cursor-pointer hover:shadow-md transition-shadow" onclick="filterByStage(5)">
                <p class="text-2xl font-bold text-red-600" id="count-stage-5">0</p>
                <p class="text-xs text-gray-600">Mechanical</p>
            </div>
            <div class="glass-panel rounded-lg p-3 cursor-pointer hover:shadow-md transition-shadow" onclick="filterByStage(7)">
                <p class="text-2xl font-bold text-blue-600" id="count-stage-7">0</p>
                <p class="text-xs text-gray-600">Valeting</p>
            </div>
            <div class="glass-panel rounded-lg p-3 cursor-pointer hover:shadow-md transition-shadow" onclick="filterByStage(9)">
                <p class="text-2xl font-bold text-green-600" id="count-stage-9">0</p>
                <p class="text-xs text-gray-600">Ready</p>
            </div>
            <div class="glass-panel rounded-lg p-3 cursor-pointer hover:shadow-md transition-shadow" onclick="filterByStage(0)">
                <p class="text-2xl font-bold text-gray-600" id="count-total">0</p>
                <p class="text-xs text-gray-600">Total</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="glass-panel rounded-xl p-4 shadow-sm mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" id="searchInput" placeholder="Stock No, Reg, Make..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                           onkeyup="filterTable()">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Stage</label>
                    <select id="stageFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" onchange="filterTable()">
                        <option value="">All Stages</option>
                        <option value="1">1. Vehicle Intake</option>
                        <option value="2">2. Bodywork & Cosmetic</option>
                        <option value="3">3. Dent & Paint Repairs</option>
                        <option value="4">4. Legal & Documentation</option>
                        <option value="5">5. Mechanical & Diagnostic</option>
                        <option value="6">6. External & Electrical</option>
                        <option value="7">7. Interior & Valeting</option>
                        <option value="8">8. Fault Overview</option>
                        <option value="9">9. Ready for Advertising</option>
                        <option value="10">10. Customer Delivery</option>
                        <option value="11">11. Accounts & Warranty</option>
                        <option value="12">12. Management Overview</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Assigned To</label>
                    <select id="assignedFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" onchange="filterTable()">
                        <option value="">All Staff</option>
                        <option value="Keith Hardy">Keith Hardy</option>
                        <option value="Ibrahim Ata">Ibrahim Ata</option>
                        <option value="Ali Amood">Ali Amood</option>
                        <option value="Morteza Rahamian">Morteza Rahamian</option>
                        <option value="Marcin Kiljan">Marcin Kiljan</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Location</label>
                    <select id="locationFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" onchange="filterTable()">
                        <option value="">All Locations</option>
                        <option value="Stanmore Retail">Stanmore Retail</option>
                        <option value="Stanmore 2">Stanmore 2</option>
                        <option value="Stanmore PDI">Stanmore PDI</option>
                        <option value="With Supplier">With Supplier</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Status Table -->
        <div class="glass-panel rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 uppercase">Stock No</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 uppercase">Vehicle</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 uppercase">Current Stage</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 uppercase">Progress</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 uppercase">Assigned To</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 uppercase">Location</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 uppercase">Days in Stage</th>
                            <th class="px-4 py-3 text-xs font-semibold text-gray-600 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="statusTableBody" class="divide-y divide-gray-200">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const stageNames = {
            1: "Vehicle Intake",
            2: "Bodywork & Cosmetic", 
            3: "Dent & Paint Repairs",
            4: "Legal & Documentation",
            5: "Mechanical & Diagnostic",
            6: "External & Electrical",
            7: "Interior & Valeting",
            8: "Fault Overview",
            9: "Ready for Advertising",
            10: "Customer Delivery",
            11: "Accounts & Warranty",
            12: "Management Overview"
        };

        const stageColors = {
            1: "bg-yellow-100 text-yellow-800",
            2: "bg-orange-100 text-orange-800",
            3: "bg-red-100 text-red-800",
            4: "bg-purple-100 text-purple-800",
            5: "bg-pink-100 text-pink-800",
            6: "bg-indigo-100 text-indigo-800",
            7: "bg-blue-100 text-blue-800",
            8: "bg-cyan-100 text-cyan-800",
            9: "bg-green-100 text-green-800",
            10: "bg-emerald-100 text-emerald-800",
            11: "bg-teal-100 text-teal-800",
            12: "bg-gray-100 text-gray-800"
        };

        let allVehicles = [];
        let filteredVehicles = [];

        function loadData() {
            // Load vehicles from localStorage
            const vehicles = JSON.parse(localStorage.getItem('capeye_vehicles') || '[]');
            
            // Enrich with workflow data
            allVehicles = vehicles.map(v => {
                const workflowKey = 'workflow_' + v.stockNo;
                const workflowData = JSON.parse(localStorage.getItem(workflowKey) || '{}');
                
                // Determine current stage
                let currentStage = 1;
                let stageProgress = 0;
                
                for (let i = 12; i >= 1; i--) {
                    if (workflowData['stage' + i] && workflowData['stage' + i].status === 'completed') {
                        currentStage = i + 1;
                        stageProgress = i;
                        break;
                    }
                }
                
                if (currentStage > 12) {
                    currentStage = 12;
                    stageProgress = 12;
                }
                
                // Get assigned user from current stage data
                const stageData = workflowData['stage' + currentStage] || {};
                const assignedTo = stageData.data && stageData.data.inspectorName ? stageData.data.inspectorName : (stageData.completedBy || "Unassigned");
                
                // Calculate days in current stage
                const stageStart = stageData.completedAt ? new Date(stageData.completedAt) : new Date(v.dateInStock || Date.now());
                const daysInStage = Math.floor((new Date() - stageStart) / (1000 * 60 * 60 * 24));
                
                return {
                    ...v,
                    currentStage,
                    stageProgress,
                    assignedTo,
                    daysInStage,
                    workflowData
                };
            });
            
            filteredVehicles = [...allVehicles];
            updateStats();
            renderTable();
        }

        function updateStats() {
            const counts = {};
            for (let i = 1; i <= 12; i++) {
                counts[i] = allVehicles.filter(v => v.currentStage === i).length;
            }
            
            document.getElementById('count-stage-1').textContent = counts[1];
            document.getElementById('count-stage-2').textContent = counts[2] + counts[3];
            document.getElementById('count-stage-5').textContent = counts[5] + counts[6];
            document.getElementById('count-stage-7').textContent = counts[7] + counts[8];
            document.getElementById('count-stage-9').textContent = counts[9];
            document.getElementById('count-total').textContent = allVehicles.length;
        }

        function renderTable() {
            const tbody = document.getElementById('statusTableBody');
            
            if (filteredVehicles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No vehicles found matching your criteria</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredVehicles.map(v => {
                const progressPercent = (v.stageProgress / 12) * 100;
                const daysColor = v.daysInStage > 7 ? 'text-red-600 font-semibold' : v.daysInStage > 3 ? 'text-orange-600' : 'text-gray-600';
                
                return '<tr class="table-row cursor-pointer" onclick="openWorkflow(\'' + v.stockNo + '\')">' +
                    '<td class="px-4 py-3 text-sm font-medium text-gray-900">' + v.stockNo + '</td>' +
                    '<td class="px-4 py-3">' +
                        '<div class="text-sm font-medium text-gray-900">' + v.make + ' ' + v.model + '</div>' +
                        '<div class="text-xs text-gray-500">' + (v.registration || 'No Reg') + '</div>' +
                    '</td>' +
                    '<td class="px-4 py-3">' +
                        '<span class="stage-badge inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + stageColors[v.currentStage] + '">' +
                            v.currentStage + '. ' + stageNames[v.currentStage] +
                        '</span>' +
                    '</td>' +
                    '<td class="px-4 py-3">' +
                        '<div class="w-full bg-gray-200 rounded-full h-2">' +
                            '<div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: ' + progressPercent + '%"></div>' +
                        '</div>' +
                        '<span class="text-xs text-gray-500">' + Math.round(progressPercent) + '% complete</span>' +
                    '</td>' +
                    '<td class="px-4 py-3 text-sm text-gray-600">' + v.assignedTo + '</td>' +
                    '<td class="px-4 py-3 text-sm text-gray-600">' + v.location + '</td>' +
                    '<td class="px-4 py-3 text-sm ' + daysColor + '">' + v.daysInStage + ' days</td>' +
                    '<td class="px-4 py-3">' +
                        '<button onclick="event.stopPropagation(); openWorkflow(\'' + v.stockNo + '\')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Update</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function filterTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const stage = document.getElementById('stageFilter').value;
            const assigned = document.getElementById('assignedFilter').value;
            const location = document.getElementById('locationFilter').value;
            
            filteredVehicles = allVehicles.filter(v => {
                const matchesSearch = !search || 
                    (v.stockNo && v.stockNo.toLowerCase().includes(search)) ||
                    (v.registration && v.registration.toLowerCase().includes(search)) ||
                    (v.make && v.make.toLowerCase().includes(search));
                
                const matchesStage = !stage || v.currentStage === parseInt(stage);
                const matchesAssigned = !assigned || v.assignedTo === assigned;
                const matchesLocation = !location || v.location === location;
                
                return matchesSearch && matchesStage && matchesAssigned && matchesLocation;
            });
            
            renderTable();
        }

        function filterByStage(stage) {
            if (stage === 0) {
                document.getElementById('stageFilter').value = '';
            } else {
                document.getElementById('stageFilter').value = stage;
            }
            filterTable();
        }

        function openWorkflow(stockNo) {
            window.location.href = 'workflow.html?stockNo=' + stockNo;
        }

        function refreshData() {
            loadData();
            showNotification('Data refreshed');
        }

        function showNotification(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function logout() {
            localStorage.removeItem('capeye_session');
            window.location.href = 'login.html';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const session = localStorage.getItem('capeye_session');
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            
            loadData();
        });
    </script>
</body>
</html>
