<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 3: Dent & Paint Repairs - Capeye Auto Capital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #8b5cf6;
            --accent: #f59e0b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --darker: #020617;
            --card: #1e293b;
            --border: #334155;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: #e2e8f0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 12px;
        }
        
        .stage-badge {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .form-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-section h3 {
            color: #8b5cf6;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            color: #94a3b8;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .form-control {
            background: var(--darker);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: #e2e8f0;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        
        .form-control:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .photo-slot {
            aspect-ratio: 4/3;
            background: var(--darker);
            border: 2px dashed var(--border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .photo-slot:hover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        
        .photo-slot.has-image {
            border-style: solid;
            border-color: #8b5cf6;
        }
        
        .photo-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-slot .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .photo-slot:hover .remove-btn {
            opacity: 1;
        }
        
        .signature-pad {
            background: white;
            border-radius: 8px;
            height: 200px;
            cursor: crosshair;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(139, 92, 246, 0.3);
        }
        
        .btn-secondary {
            background: var(--border);
            color: #e2e8f0;
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        .damage-item {
            background: var(--darker);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .damage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .damage-title {
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .severity-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .severity-minor { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .severity-moderate { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .severity-severe { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin: 2rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
            width: 25%;
            transition: width 0.3s;
        }
        
        .stage-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .stage-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.5;
        }
        
        .stage-step.active {
            opacity: 1;
        }
        
        .stage-step.completed {
            opacity: 1;
        }
        
        .stage-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border: 2px solid transparent;
        }
        
        .stage-step.active .stage-dot {
            background: #8b5cf6;
            border-color: #a78bfa;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
        }
        
        .stage-step.completed .stage-dot {
            background: #10b981;
            border-color: #34d399;
        }
        
        .stage-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-align: center;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }
        
        .previous-summary {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .cost-input {
            position: relative;
        }
        
        .cost-input::before {
            content: '£';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }
        
        .cost-input input {
            padding-left: 1.75rem;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stage-indicator {
                overflow-x: auto;
                gap: 1rem;
            }
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="glass-panel p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <span class="stage-badge">Stage 3 of 12</span>
                        <span class="text-sm text-gray-400">Bodyshop Department</span>
                    </div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white">Dent & Paint Repairs</h1>
                    <p class="text-gray-400 mt-1">Complete paint work assessment, cost estimation, and repair tracking</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="saveDraft()" class="btn-secondary">
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button onclick="submitForm()" class="btn-primary">
                        <i class="fas fa-check-circle"></i> Complete Stage
                    </button>
                </div>
            </div>
            
            <!-- Progress -->
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            
            <!-- Stage Navigation -->
            <div class="stage-indicator">
                <div class="stage-step completed">
                    <div class="stage-dot"><i class="fas fa-check"></i></div>
                    <span class="stage-label">Intake</span>
                </div>
                <div class="stage-step completed">
                    <div class="stage-dot"><i class="fas fa-check"></i></div>
                    <span class="stage-label">Bodywork</span>
                </div>
                <div class="stage-step active">
                    <div class="stage-dot">3</div>
                    <span class="stage-label">Paint</span>
                </div>
                <div class="stage-step">
                    <div class="stage-dot">4</div>
                    <span class="stage-label">Legal</span>
                </div>
                <div class="stage-step">
                    <div class="stage-dot">5</div>
                    <span class="stage-label">Mechanical</span>
                </div>
                <div class="stage-step">
                    <div class="stage-dot">6</div>
                    <span class="stage-label">External</span>
                </div>
                <div class="stage-step">
                    <div class="stage-dot">7</div>
                    <span class="stage-label">Valeting</span>
                </div>
                <div class="stage-step">
                    <div class="stage-dot">8</div>
                    <span class="stage-label">Faults</span>
                </div>
                <div class="stage-step">
                    <div class="stage-dot">9</div>
                    <span class="stage-label">Ready</span>
                </div>
                <div class="stage-step">
                    <div class="stage-dot">10</div>
                    <span class="stage-label">Delivery</span>
                </div>
                <div class="stage-step">
                    <div class="stage-dot">11</div>
                    <span class="stage-label">Accounts</span>
                </div>
                <div class="stage-step">
                    <div class="stage-dot">12</div>
                    <span class="stage-label">Management</span>
                </div>
            </div>
        </div>

        <!-- Vehicle Selection -->
        <div class="glass-panel p-6 mb-6">
            <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-car"></i> Select Vehicle</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Stock Number *</label>
                    <select id="stockNo" class="form-control" onchange="loadVehicleData()">
                        <option value="">Select Stock Number...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Registration</label>
                    <input type="text" id="registration" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Make & Model</label>
                    <input type="text" id="makeModel" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Colour</label>
                    <input type="text" id="colour" class="form-control" readonly>
                </div>
            </div>
        </div>

        <!-- Previous Stage Summary -->
        <div id="previousSummary" class="previous-summary" style="display: none;">
            <h4 class="font-semibold text-purple-400 mb-2"><i class="fas fa-history"></i> Stage 2 Summary - Bodywork Assessment</h4>
            <div id="previousData" class="text-sm text-gray-300"></div>
        </div>

        <form id="stage3Form">
            <!-- Section 1: Paint Damage Assessment -->
            <div class="form-section">
                <h3><i class="fas fa-paint-roller"></i> Paint Damage Assessment</h3>
                
                <div class="damage-item">
                    <div class="damage-header">
                        <span class="damage-title">Panel Damage Overview</span>
                        <span class="severity-badge severity-moderate" id="overallSeverity">Moderate</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Total Panels Requiring Paint *</label>
                            <input type="number" id="panelsCount" class="form-control" min="0" max="20" required onchange="calculateEstimate()">
                        </div>
                        <div class="form-group">
                            <label>Panels Requiring Blending</label>
                            <input type="number" id="blendingPanels" class="form-control" min="0" max="20" onchange="calculateEstimate()">
                        </div>
                        <div class="form-group">
                            <label>Metallic/Pearl Finish</label>
                            <select id="finishType" class="form-control" onchange="calculateEstimate()">
                                <option value="standard">Standard Solid</option>
                                <option value="metallic">Metallic (+20%)</option>
                                <option value="pearl">Pearl/Mica (+30%)</option>
                                <option value="tri-coat">Tri-Coat (+40%)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Colour Match Complexity</label>
                            <select id="colourMatch" class="form-control">
                                <option value="easy">Easy Match</option>
                                <option value="moderate">Moderate</option>
                                <option value="difficult">Difficult/Variable</option>
                                <option value="very-difficult">Very Difficult (e.g. Red, White)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="damage-item">
                    <div class="damage-header">
                        <span class="damage-title">Specific Damage Areas</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Bonnet Condition</label>
                            <select id="bonnetCondition" class="form-control">
                                <option value="none">No Work Required</option>
                                <option value="polish">Polish Only</option>
                                <option value="touchup">Touch-up</option>
                                <option value="respray">Full Respray</option>
                                <option value="repair-respray">Repair & Respray</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Front Bumper</label>
                            <select id="frontBumperCondition" class="form-control">
                                <option value="none">No Work Required</option>
                                <option value="polish">Polish Only</option>
                                <option value="touchup">Touch-up</option>
                                <option value="respray">Full Respray</option>
                                <option value="repair-respray">Repair & Respray</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Rear Bumper</label>
                            <select id="rearBumperCondition" class="form-control">
                                <option value="none">No Work Required</option>
                                <option value="polish">Polish Only</option>
                                <option value="touchup">Touch-up</option>
                                <option value="respray">Full Respray</option>
                                <option value="repair-respray">Repair & Respray</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Driver Side Doors</label>
                            <select id="driverDoorsCondition" class="form-control">
                                <option value="none">No Work Required</option>
                                <option value="polish">Polish Only</option>
                                <option value="touchup">Touch-up</option>
                                <option value="respray">Full Respray</option>
                                <option value="repair-respray">Repair & Respray</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Passenger Side Doors</label>
                            <select id="passengerDoorsCondition" class="form-control">
                                <option value="none">No Work Required</option>
                                <option value="polish">Polish Only</option>
                                <option value="touchup">Touch-up</option>
                                <option value="respray">Full Respray</option>
                                <option value="repair-respray">Repair & Respray</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Roof</label>
                            <select id="roofCondition" class="form-control">
                                <option value="none">No Work Required</option>
                                <option value="polish">Polish Only</option>
                                <option value="touchup">Touch-up</option>
                                <option value="respray">Full Respray</option>
                                <option value="repair-respray">Repair & Respray</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tailgate/Boot Lid</label>
                            <select id="tailgateCondition" class="form-control">
                                <option value="none">No Work Required</option>
                                <option value="polish">Polish Only</option>
                                <option value="touchup">Touch-up</option>
                                <option value="respray">Full Respray</option>
                                <option value="repair-respray">Repair & Respray</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Wing Mirrors</label>
                            <select id="mirrorsCondition" class="form-control">
                                <option value="none">No Work Required</option>
                                <option value="polish">Polish Only</option>
                                <option value="touchup">Touch-up</option>
                                <option value="respray">Full Respray</option>
                                <option value="replace">Replace Unit</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Cost Estimation -->
            <div class="form-section">
                <h3><i class="fas fa-calculator"></i> Cost Estimation</h3>
                <div class="form-grid">
                    <div class="form-group cost-input">
                        <label>Estimated Labour Hours</label>
                        <input type="number" id="labourHours" class="form-control" step="0.5" onchange="calculateEstimate()">
                    </div>
                    <div class="form-group cost-input">
                        <label>Labour Rate (£/hour)</label>
                        <input type="number" id="labourRate" class="form-control" value="45.00" onchange="calculateEstimate()">
                    </div>
                    <div class="form-group cost-input">
                        <label>Materials Cost</label>
                        <input type="number" id="materialsCost" class="form-control" step="0.01" onchange="calculateEstimate()">
                    </div>
                    <div class="form-group cost-input">
                        <label>Paint & Consumables</label>
                        <input type="number" id="paintCost" class="form-control" step="0.01" onchange="calculateEstimate()">
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-slate-800 rounded-lg border border-slate-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400">Labour Total:</span>
                        <span class="text-white font-mono" id="labourTotal">£0.00</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400">Materials Total:</span>
                        <span class="text-white font-mono" id="materialsTotal">£0.00</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400">Paint & Consumables:</span>
                        <span class="text-white font-mono" id="paintTotal">£0.00</span>
                    </div>
                    <div class="border-t border-slate-600 pt-2 mt-2">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold text-purple-400">Total Estimate:</span>
                            <span class="text-2xl font-bold text-white font-mono" id="totalEstimate">£0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Repair Planning -->
            <div class="form-section">
                <h3><i class="fas fa-tasks"></i> Repair Planning</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Assigned Technician *</label>
                        <select id="assignedTechnician" class="form-control" required>
                            <option value="">Select Technician...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estimated Start Date</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Estimated Completion Date</label>
                        <input type="date" id="completionDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Priority Level</label>
                        <select id="priorityLevel" class="form-control">
                            <option value="normal">Normal</option>
                            <option value="high">High - Customer Waiting</option>
                            <option value="urgent">Urgent - Sold Vehicle</option>
                            <option value="low">Low - Stock Vehicle</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group mt-4">
                    <label>Repair Notes & Special Instructions</label>
                    <textarea id="repairNotes" class="form-control" placeholder="Detail any special requirements, customer requests, or technical notes..."></textarea>
                </div>
                
                <div class="form-group mt-4">
                    <label>Parts Required</label>
                    <div id="partsList" class="space-y-2">
                        <div class="flex gap-2">
                            <select class="form-control flex-1 part-select">
                                <option value="">Select Part...</option>
                            </select>
                            <input type="number" class="form-control w-24" placeholder="Qty" min="1" value="1">
                            <button type="button" class="btn-secondary px-3" onclick="removePart(this)"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <button type="button" class="btn-secondary mt-2" onclick="addPart()"><i class="fas fa-plus"></i> Add Part</button>
                </div>
            </div>

            <!-- Section 4: Photo Documentation -->
            <div class="form-section">
                <h3><i class="fas fa-camera"></i> Photo Documentation</h3>
                <p class="text-sm text-gray-400 mb-4">Capture before, during, and after photos of paint work. Minimum 4 photos required.</p>
                
                <div class="photo-grid" id="photoGrid">
                    <div class="photo-slot" onclick="triggerUpload(0)">
                        <i class="fas fa-plus text-2xl text-gray-500 mb-2"></i>
                        <span class="text-xs text-gray-500">Overall Before</span>
                        <input type="file" id="photo0" accept="image/*" style="display: none;" onchange="handlePhoto(0, this)">
                    </div>
                    <div class="photo-slot" onclick="triggerUpload(1)">
                        <i class="fas fa-plus text-2xl text-gray-500 mb-2"></i>
                        <span class="text-xs text-gray-500">Damage Close-up</span>
                        <input type="file" id="photo1" accept="image/*" style="display: none;" onchange="handlePhoto(1, this)">
                    </div>
                    <div class="photo-slot" onclick="triggerUpload(2)">
                        <i class="fas fa-plus text-2xl text-gray-500 mb-2"></i>
                        <span class="text-xs text-gray-500">During Repair</span>
                        <input type="file" id="photo2" accept="image/*" style="display: none;" onchange="handlePhoto(2, this)">
                    </div>
                    <div class="photo-slot" onclick="triggerUpload(3)">
                        <i class="fas fa-plus text-2xl text-gray-500 mb-2"></i>
                        <span class="text-xs text-gray-500">After Completion</span>
                        <input type="file" id="photo3" accept="image/*" style="display: none;" onchange="handlePhoto(3, this)">
                    </div>
                    <div class="photo-slot" onclick="triggerUpload(4)">
                        <i class="fas fa-plus text-2xl text-gray-500 mb-2"></i>
                        <span class="text-xs text-gray-500">Colour Match</span>
                        <input type="file" id="photo4" accept="image/*" style="display: none;" onchange="handlePhoto(4, this)">
                    </div>
                    <div class="photo-slot" onclick="triggerUpload(5)">
                        <i class="fas fa-plus text-2xl text-gray-500 mb-2"></i>
                        <span class="text-xs text-gray-500">Additional</span>
                        <input type="file" id="photo5" accept="image/*" style="display: none;" onchange="handlePhoto(5, this)">
                    </div>
                </div>
            </div>

            <!-- Section 5: Quality Check -->
            <div class="form-section">
                <h3><i class="fas fa-clipboard-check"></i> Quality Checklist</h3>
                <div class="space-y-3">
                    <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition">
                        <input type="checkbox" class="w-5 h-5 rounded border-slate-600 text-purple-600 focus:ring-purple-500" id="qcColourMatch">
                        <span class="text-gray-300">Colour match verified in daylight and artificial light</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition">
                        <input type="checkbox" class="w-5 h-5 rounded border-slate-600 text-purple-600 focus:ring-purple-500" id="qcOrangePeel">
                        <span class="text-gray-300">No orange peel or texture mismatch</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition">
                        <input type="checkbox" class="w-5 h-5 rounded border-slate-600 text-purple-600 focus:ring-purple-500" id="qcOverspray">
                        <span class="text-gray-300">No overspray on adjacent panels or trim</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition">
                        <input type="checkbox" class="w-5 h-5 rounded border-slate-600 text-purple-600 focus:ring-purple-500" id="qcPolishing">
                        <span class="text-gray-300">Final polishing completed to match factory finish</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition">
                        <input type="checkbox" class="w-5 h-5 rounded border-slate-600 text-purple-600 focus:ring-purple-500" id="qcMasking">
                        <span class="text-gray-300">All masking lines clean and straight</span>
                    </label>
                </div>
            </div>

            <!-- Section 6: Sign-off -->
            <div class="form-section">
                <h3><i class="fas fa-signature"></i> Sign-off</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Completed By *</label>
                        <select id="completedBy" class="form-control" required>
                            <option value="">Select Staff Member...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Completion Date *</label>
                        <input type="date" id="completionDateActual" class="form-control" required>
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Digital Signature *</label>
                    <canvas id="signaturePad" class="signature-pad w-full"></canvas>
                    <button type="button" class="btn-secondary mt-2" onclick="clearSignature()">
                        <i class="fas fa-undo"></i> Clear Signature
                    </button>
                </div>
            </div>
        </form>

        <!-- Action Buttons -->
        <div class="flex justify-between items-center mt-6">
            <button onclick="window.location.href='stage-2-bodywork.html'" class="btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Stage 2
            </button>
            <div class="flex gap-3">
                <button onclick="saveDraft()" class="btn-secondary">
                    <i class="fas fa-save"></i> Save Draft
                </button>
                <button onclick="submitForm()" class="btn-primary">
                    <i class="fas fa-check-circle"></i> Complete Stage 3
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let vehicles = [];
        let staff = [];
        let parts = [];
        let currentVehicle = null;
        let uploadedPhotos = {};
        let signaturePad = null;
        let isDrawing = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initSignaturePad();
            setupAutoSave();
            
            // Set today's date
            document.getElementById('completionDateActual').valueAsDate = new Date();
        });

        // Load CSV data
        function loadData() {
            // Load vehicles
            Papa.parse('Auto Capital - Stock List-639068391990284525.csv', {
                download: true,
                header: true,
                complete: function(results) {
                    vehicles = results.data.filter(v => v['Stock No'] || v['StockNo']);
                    populateVehicleDropdown();
                }
            });

            // Load staff
            Papa.parse('Auto Capital - Staff List-639068391990284525.csv', {
                download: true,
                header: true,
                complete: function(results) {
                    staff = results.data.filter(s => s['Name'] || s['Staff Name']);
                    populateStaffDropdowns();
                }
            });

            // Load parts
            Papa.parse('Auto Capital - Parts Recommended-639068391990284525.csv', {
                download: true,
                header: true,
                complete: function(results) {
                    parts = results.data.filter(p => p['Part Name'] || p['PartName']);
                    populatePartsDropdowns();
                }
            });
        }

        function populateVehicleDropdown() {
            const select = document.getElementById('stockNo');
            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle['Stock No'] || vehicle['StockNo'];
                option.textContent = `${vehicle['Stock No'] || vehicle['StockNo']} - ${vehicle['Make']} ${vehicle['Model']}`;
                select.appendChild(option);
            });
        }

        function populateStaffDropdowns() {
            const technicians = staff.filter(s => 
                (s['Department'] === 'Workshop' || s['Department'] === 'Bodyshop') &&
                (s['Role']?.includes('Technician') || s['Role']?.includes('Paint') || s['Role']?.includes('Body'))
            );
            
            const technicianSelect = document.getElementById('assignedTechnician');
            const completedBySelect = document.getElementById('completedBy');
            
            technicians.forEach(t => {
                const name = t['Name'] || t['Staff Name'];
                const option1 = document.createElement('option');
                option1.value = name;
                option1.textContent = `${name} - ${t['Role']}`;
                technicianSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = name;
                option2.textContent = name;
                completedBySelect.appendChild(option2);
            });
        }

        function populatePartsDropdowns() {
            const selects = document.querySelectorAll('.part-select');
            selects.forEach(select => {
                parts.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p['Part Name'] || p['PartName'];
                    option.textContent = p['Part Name'] || p['PartName'];
                    select.appendChild(option);
                });
            });
        }

        function loadVehicleData() {
            const stockNo = document.getElementById('stockNo').value;
            if (!stockNo) return;
            
            currentVehicle = vehicles.find(v => (v['Stock No'] || v['StockNo']) === stockNo);
            if (currentVehicle) {
                document.getElementById('registration').value = currentVehicle['Registration'] || '';
                document.getElementById('makeModel').value = `${currentVehicle['Make']} ${currentVehicle['Model']}`;
                document.getElementById('colour').value = currentVehicle['Colour'] || '';
                
                // Load previous stage data
                loadPreviousStageData(stockNo);
                // Load draft if exists
                loadDraft(stockNo);
            }
        }

        function loadPreviousStageData(stockNo) {
            const saved = localStorage.getItem(`capeye_vehicle_${stockNo}`);
            if (saved) {
                const data = JSON.parse(saved);
                if (data.stage2) {
                    document.getElementById('previousSummary').style.display = 'block';
                    const summary = document.getElementById('previousData');
                    const s = data.stage2;
                    summary.innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Bodywork Status:</strong> ${s.overallCondition || 'N/A'}</div>
                            <div><strong>Panels Needing Paint:</strong> ${s.panelsNeedingPaint || 'N/A'}</div>
                            <div><strong>Assessed By:</strong> ${s.assessedBy || 'N/A'}</div>
                            <div><strong>Date:</strong> ${s.completionDate || 'N/A'}</div>
                        </div>
                        ${s.damageNotes ? `<div class="mt-2"><strong>Notes:</strong> ${s.damageNotes}</div>` : ''}
                    `;
                }
            }
        }

        // Cost calculation
        function calculateEstimate() {
            const labourHours = parseFloat(document.getElementById('labourHours').value) || 0;
            const labourRate = parseFloat(document.getElementById('labourRate').value) || 0;
            const materialsCost = parseFloat(document.getElementById('materialsCost').value) || 0;
            const paintCost = parseFloat(document.getElementById('paintCost').value) || 0;
            
            // Apply finish multiplier
            const finishType = document.getElementById('finishType').value;
            let multiplier = 1;
            if (finishType === 'metallic') multiplier = 1.2;
            if (finishType === 'pearl') multiplier = 1.3;
            if (finishType === 'tri-coat') multiplier = 1.4;
            
            const labourTotal = labourHours * labourRate;
            const adjustedPaintCost = paintCost * multiplier;
            const total = labourTotal + materialsCost + adjustedPaintCost;
            
            document.getElementById('labourTotal').textContent = `£${labourTotal.toFixed(2)}`;
            document.getElementById('materialsTotal').textContent = `£${materialsCost.toFixed(2)}`;
            document.getElementById('paintTotal').textContent = `£${adjustedPaintCost.toFixed(2)}`;
            document.getElementById('totalEstimate').textContent = `£${total.toFixed(2)}`;
        }

        // Parts management
        function addPart() {
            const container = document.getElementById('partsList');
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.innerHTML = `
                <select class="form-control flex-1 part-select">
                    <option value="">Select Part...</option>
                    ${parts.map(p => `<option value="${p['Part Name'] || p['PartName']}">${p['Part Name'] || p['PartName']}</option>`).join('')}
                </select>
                <input type="number" class="form-control w-24" placeholder="Qty" min="1" value="1">
                <button type="button" class="btn-secondary px-3" onclick="removePart(this)"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(div);
        }

        function removePart(btn) {
            btn.closest('.flex').remove();
        }

        // Photo handling
        function triggerUpload(index) {
            document.getElementById(`photo${index}`).click();
        }

        function handlePhoto(index, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const slot = input.closest('.photo-slot');
                    slot.innerHTML = `
                        <img src="${e.target.result}" alt="Photo ${index + 1}">
                        <button type="button" class="remove-btn" onclick="removePhoto(${index}, event)">Remove</button>
                    `;
                    slot.classList.add('has-image');
                    uploadedPhotos[index] = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removePhoto(index, event) {
            event.stopPropagation();
            const slot = document.getElementById(`photo${index}`).closest('.photo-slot');
            slot.innerHTML = `
                <i class="fas fa-plus text-2xl text-gray-500 mb-2"></i>
                <span class="text-xs text-gray-500">${getPhotoLabel(index)}</span>
                <input type="file" id="photo${index}" accept="image/*" style="display: none;" onchange="handlePhoto(${index}, this)">
            `;
            slot.classList.remove('has-image');
            delete uploadedPhotos[index];
        }

        function getPhotoLabel(index) {
            const labels = ['Overall Before', 'Damage Close-up', 'During Repair', 'After Completion', 'Colour Match', 'Additional'];
            return labels[index] || 'Photo';
        }

        // Signature pad
        function initSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 200;
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            signaturePad = { canvas, ctx };
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signaturePad.canvas.getBoundingClientRect();
            signaturePad.ctx.beginPath();
            signaturePad.ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = signaturePad.canvas.getBoundingClientRect();
            signaturePad.ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            signaturePad.ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signaturePad.canvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            if (signaturePad) {
                signaturePad.ctx.clearRect(0, 0, signaturePad.canvas.width, signaturePad.canvas.height);
            }
        }

        // Form submission
        function submitForm() {
            if (!validateForm()) return;
            
            const stockNo = document.getElementById('stockNo').value;
            const formData = collectFormData();
            
            // Save to localStorage
            const existing = localStorage.getItem(`capeye_vehicle_${stockNo}`);
            const vehicleData = existing ? JSON.parse(existing) : {};
            vehicleData.stage3 = formData;
            vehicleData.currentStage = 4;
            vehicleData.lastUpdated = new Date().toISOString();
            
            localStorage.setItem(`capeye_vehicle_${stockNo}`, JSON.stringify(vehicleData));
            
            alert('Stage 3 completed successfully! Moving to Stage 4: Legal & Documentation.');
            window.location.href = 'stage-4-legal.html?stockNo=' + stockNo;
        }

        function validateForm() {
            const required = ['stockNo', 'panelsCount', 'assignedTechnician', 'completedBy', 'completionDateActual'];
            for (let field of required) {
                const el = document.getElementById(field);
                if (!el.value) {
                    el.focus();
                    alert('Please fill in all required fields');
                    return false;
                }
            }
            
            // Check signature
            if (signaturePad) {
                const pixelData = signaturePad.canvas.toDataURL();
                if (pixelData.length < 1000) {
                    alert('Please provide a signature');
                    return false;
                }
            }
            
            return true;
        }

        function collectFormData() {
            const partsRequired = [];
            document.querySelectorAll('#partsList > div').forEach(div => {
                const selects = div.querySelectorAll('select, input');
                if (selects[0].value) {
                    partsRequired.push({
                        part: selects[0].value,
                        quantity: selects[1].value
                    });
                }
            });
            
            return {
                panelsCount: document.getElementById('panelsCount').value,
                blendingPanels: document.getElementById('blendingPanels').value,
                finishType: document.getElementById('finishType').value,
                colourMatch: document.getElementById('colourMatch').value,
                bonnetCondition: document.getElementById('bonnetCondition').value,
                frontBumperCondition: document.getElementById('frontBumperCondition').value,
                rearBumperCondition: document.getElementById('rearBumperCondition').value,
                driverDoorsCondition: document.getElementById('driverDoorsCondition').value,
                passengerDoorsCondition: document.getElementById('passengerDoorsCondition').value,
                roofCondition: document.getElementById('roofCondition').value,
                tailgateCondition: document.getElementById('tailgateCondition').value,
                mirrorsCondition: document.getElementById('mirrorsCondition').value,
                labourHours: document.getElementById('labourHours').value,
                labourRate: document.getElementById('labourRate').value,
                materialsCost: document.getElementById('materialsCost').value,
                paintCost: document.getElementById('paintCost').value,
                totalEstimate: document.getElementById('totalEstimate').textContent,
                assignedTechnician: document.getElementById('assignedTechnician').value,
                startDate: document.getElementById('startDate').value,
                completionDate: document.getElementById('completionDate').value,
                priorityLevel: document.getElementById('priorityLevel').value,
                repairNotes: document.getElementById('repairNotes').value,
                partsRequired: partsRequired,
                photos: uploadedPhotos,
                qcColourMatch: document.getElementById('qcColourMatch').checked,
                qcOrangePeel: document.getElementById('qcOrangePeel').checked,
                qcOverspray: document.getElementById('qcOverspray').checked,
                qcPolishing: document.getElementById('qcPolishing').checked,
                qcMasking: document.getElementById('qcMasking').checked,
                completedBy: document.getElementById('completedBy').value,
                completionDate: document.getElementById('completionDateActual').value,
                signature: signaturePad ? signaturePad.canvas.toDataURL() : null,
                submittedAt: new Date().toISOString()
            };
        }

        // Auto-save functionality
        function setupAutoSave() {
            setInterval(() => {
                const stockNo = document.getElementById('stockNo').value;
                if (stockNo) {
                    saveDraft(stockNo, true);
                }
            }, 30000); // Auto-save every 30 seconds
        }

        function saveDraft(stockNo = null, silent = false) {
            if (!stockNo) stockNo = document.getElementById('stockNo').value;
            if (!stockNo) {
                if (!silent) alert('Please select a vehicle first');
                return;
            }
            
            const draftData = collectFormData();
            draftData.isDraft = true;
            draftData.lastSaved = new Date().toISOString();
            
            const existing = localStorage.getItem(`capeye_vehicle_${stockNo}`);
            const vehicleData = existing ? JSON.parse(existing) : {};
            vehicleData.stage3Draft = draftData;
            
            localStorage.setItem(`capeye_vehicle_${stockNo}`, JSON.stringify(vehicleData));
            if (!silent) alert('Draft saved successfully!');
        }

        function loadDraft(stockNo) {
            const saved = localStorage.getItem(`capeye_vehicle_${stockNo}`);
            if (!saved) return;
            
            const data = JSON.parse(saved);
            if (data.stage3Draft) {
                const draft = data.stage3Draft;
                // Populate form fields
                Object.keys(draft).forEach(key => {
                    const el = document.getElementById(key);
                    if (el && draft[key]) {
                        if (el.type === 'checkbox') {
                            el.checked = draft[key];
                        } else {
                            el.value = draft[key];
                        }
                    }
                });
                
                // Restore photos
                if (draft.photos) {
                    uploadedPhotos = draft.photos;
                    Object.keys(uploadedPhotos).forEach(index => {
                        const slot = document.getElementById(`photo${index}`).closest('.photo-slot');
                        slot.innerHTML = `
                            <img src="${uploadedPhotos[index]}" alt="Photo ${parseInt(index) + 1}">
                            <button type="button" class="remove-btn" onclick="removePhoto(${index}, event)">Remove</button>
                        `;
                        slot.classList.add('has-image');
                    });
                }
            }
        }
    </script>
</body>
</html>
